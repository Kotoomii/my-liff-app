<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>予定入力</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; padding: 1em; background-color: #f4f6f9; }
  .container { background-color: white; border-radius: 16px; padding: 1.5em; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  h2 { text-align: center; color: #333; }
  .input-group { margin-bottom: 1.5em; }
  label { font-weight: bold; margin-bottom: 0.5em; display: block; color: #555; }
  select, input[type=date] {
    width: 100%;
    padding: 12px;
    font-size: 1.1em;
    border-radius: 8px;
    border: 1px solid #ccc;
    background-color: white;
    box-sizing: border-box;
  }
  .time-grid { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 8px; }
  button {
    width: 100%;
    margin-top: 2em;
    padding: 14px;
    font-size: 1.2em;
    font-weight: bold;
    color: white;
    background-color: #00B900;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }
</style>
</head>
<body>

<div class="container">
  <h2>次の日の予定を入力</h2>

  <div class="input-group">
    <label for="mid-category">中分類</label>
    <select id="mid-category"></select>
  </div>

  <div class="input-group">
    <label for="sub-category">小分類</label>
    <select id="sub-category"></select>
  </div>
  
  <div class="input-group">
    <label for="date-input">日付</label>
    <input type="date" id="date-input">
  </div>

  <div class="input-group">
    <label>開始時刻</label>
    <div class="time-grid">
      <select id="start-hour"></select>
      <span>:</span>
      <select id="start-minute"></select>
    </div>
  </div>

  <div class="input-group">
    <label>終了時刻</label>
    <div class="time-grid">
      <select id="end-hour"></select>
      <span>:</span>
      <select id="end-minute"></select>
    </div>
  </div>

  <button id="sendButton">この内容で予定を記録する</button>
</div>

<script>
  // ★★★ あなたの予定入力用LIFF IDを設定してください ★★★
  const LIFF_ID = 'ここにあなたの予定入力用LIFF IDを入力';

  // ★★★ 分類マップをここに直接記述します ★★★
  const SUB_MAP = {
    '睡眠': ['睡眠'],
    '食事': ['食事'],
    '身のまわりの用事': ['身のまわりの用事'],
    '療養・静養': ['療養・静養'],
    '仕事関連': ['仕事', '仕事のつきあい'],
    '学業': ['授業・学内の活動', '学校外の学習'],
    '家事': ['炊事・掃除・洗濯', '買い物', '子どもの世話', '家庭雑事'],
    '通勤': ['通勤'],
    '通学': ['通学'],
    '社会参加': ['社会参加'],
    '会話・交際': ['会話・交際'],
    'レジャー活動': ['スポーツ', '行楽・散策', '趣味・娯楽・教養(インターネット除く)','趣味・娯楽・教養のインターネット(動画除く)','インターネット動画'],
    'マスメディア接触': ['テレビ', '録画番組・DVD', 'ラジオ','新聞','雑誌・マンガ・本','音楽'],
    '休息': ['休憩'],
    'その他・不明': ['その他','不明']
  };

  window.onload = function() {
    setupPickers();
    initializeLiff();
  };

  function setupPickers() {
    const midCategorySelect = document.getElementById('mid-category');
    const subCategorySelect = document.getElementById('sub-category');
    
    // 中分類プルダウンを生成
    Object.keys(SUB_MAP).forEach(mid => {
      midCategorySelect.add(new Option(mid, mid));
    });

    // 中分類が変更されたら、小分類を更新する
    midCategorySelect.onchange = function() {
      const selectedMid = this.value;
      subCategorySelect.innerHTML = ''; // 小分類を一度クリア
      SUB_MAP[selectedMid].forEach(sub => {
        subCategorySelect.add(new Option(sub, sub));
      });
    };
    midCategorySelect.dispatchEvent(new Event('change')); // 初期表示

    // 時間選択プルダウンを生成
    const hours = [...Array(24).keys()].map(h => h.toString().padStart(2, '0'));
    const minutes = ['00', '15', '30', '45'];
    ['start-hour', 'end-hour'].forEach(id => {
      const select = document.getElementById(id);
      hours.forEach(h => select.add(new Option(h, h)));
    });
    ['start-minute', 'end-minute'].forEach(id => {
      const select = document.getElementById(id);
      minutes.forEach(m => select.add(new Option(m, m)));
    });

    // 明日の日付をデフォルトで設定
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const yyyy = tomorrow.getFullYear();
    const mm = String(tomorrow.getMonth() + 1).padStart(2, '0');
    const dd = String(tomorrow.getDate()).padStart(2, '0');
    document.getElementById('date-input').value = `${yyyy}-${mm}-${dd}`;
  }

  async function initializeLiff() {
    try {
      await liff.init({ liffId: LIFF_ID });
      document.getElementById('sendButton').addEventListener('click', sendMessage);
    } catch (error) {
      alert('LIFF初期化エラー: ' + JSON.stringify(error));
    }
  }

  async function sendMessage() {
    const profile = await liff.getProfile();
    const userId = profile.userId;
    
    const dateStr = document.getElementById('date-input').value;
    const startTimeStr = `${document.getElementById('start-hour').value}:${document.getElementById('start-minute').value}`;
    const endTimeStr = `${document.getElementById('end-hour').value}:${document.getElementById('end-minute').value}`;
    const activityName = document.getElementById('sub-category').value;

    if (!dateStr || !activityName) { alert('未入力の項目があります'); return; }

    const startTime = new Date(`${dateStr}T${startTimeStr}:00`);
    const endTime = new Date(`${dateStr}T${endTimeStr}:00`);

    if (endTime <= startTime) { alert('終了時刻は開始時刻より後に設定してください'); return; }

    // Botに送るメッセージを作成
    const msg = `PLAN:${userId};${dateStr};${startTimeStr};${endTimeStr};${activityName}`;
    
    try {
      if (!liff.isInClient()) { alert('LINEアプリで開いてください'); return; }
      await liff.sendMessages([{ type: 'text', text: msg }]);
      liff.closeWindow();
    } catch (error) {
      alert('送信エラー: ' + JSON.stringify(error));
    }
  }
</script>
</body>
</html>

