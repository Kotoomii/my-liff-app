<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨ãƒ•ãƒ©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åˆ†æã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #000000;
            color: white;
            height: 100vh;
            overflow: hidden;
            position: relative;
            text-shadow:
                0 0 4px rgba(255, 255, 255, 1),
                0 0 8px rgba(255, 255, 255, 0.9),
                0 0 12px rgba(255, 255, 255, 0.7),
                0 0 16px rgba(255, 255, 255, 0.5);
            -webkit-text-size-adjust: none;
            -moz-text-size-adjust: none;
            -ms-text-size-adjust: none;
            text-size-adjust: none;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ - ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠ */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 1000;
            border-bottom: 2px solid rgba(0, 255, 209, 0.5);
            box-shadow: 0 0 10px rgba(0, 255, 209, 0.3);
        }

        .logo {
            font-size: 20px;
            font-weight: bold;
        }

        .user-selector {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .current-user-display {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 15px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .current-user-display:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.05);
        }

        .user-icon-small {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            background: rgba(76, 175, 80, 0.3);
            border: 2px solid #4CAF50;
        }

        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ */
        .user-dropdown {
            position: absolute;
            top: 70px;
            right: 30px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 15px;
            min-width: 200px;
            display: none;
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 10000;
        }

        .user-dropdown.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s ease;
            margin: 5px 0;
        }

        .user-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .user-option.selected {
            background: rgba(76, 175, 80, 0.3);
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ - ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆæœ€é©åŒ–ï¼šä¸Šæ®µ3ã‚«ãƒ©ãƒ +ä¸‹æ®µã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ */
        .main-container {
            margin-top: 70px;
            height: calc(100vh - 70px);
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 15px;
            overflow: hidden;
            max-width: 100vw;
        }

        /* ä¸Šæ®µï¼šäºˆæ¸¬å€¤ãƒ»æ”¹å–„ææ¡ˆãƒ»ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®æ¨ªä¸¦ã³ */
        .top-row {
            display: flex;
            gap: 15px;
            height: 28%;
            min-height: 200px;
            max-height: 220px;
        }

        /* ä¸‹æ®µï¼šã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å…¨å¹… */
        .bottom-row {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        /* ä»Šæ—¥ã®ãƒ•ãƒ©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å€¤ - ç‹­ãè¨­å®š */
        .daily-analysis {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 15px;
            border: 2px solid rgba(0, 255, 209, 0.5);
            box-shadow: 0 0 10px rgba(0, 255, 209, 0.3), inset 0 0 10px rgba(0, 255, 209, 0.05);
            flex: 0 0 180px;
            position: relative;
            overflow-y: auto;
            min-height: 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .daily-analysis::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 70%);
            animation: pulse 8s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: rotate(0deg) scale(1); opacity: 0.3; }
            50% { transform: rotate(180deg) scale(1.1); opacity: 0.6; }
        }

        .section-title {
            font-size: 14px;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            gap: 6px;
            position: relative;
            z-index: 2;
            font-weight: 600;
            -webkit-text-size-adjust: none;
            text-size-adjust: none;
        }

        .section-icon {
            font-size: 18px;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.3));
        }

        /* ä»Šæ—¥ã®ãƒ•ãƒ©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å€¤è¡¨ç¤º - ã•ã‚‰ã«ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆåŒ– */
        .daily-frustration {
            text-align: center;
            margin: 0;
            position: relative;
            z-index: 2;
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .frustration-value {
            font-size: 2.8em;
            font-weight: bold;
            margin: 0;
            text-shadow:
                0 0 5px rgba(255, 255, 255, 1),
                0 0 10px rgba(255, 255, 255, 0.9),
                0 0 20px rgba(255, 255, 255, 0.7),
                0 0 30px rgba(255, 255, 255, 0.5);
            transition: all 1s ease;
            display: block;
            line-height: 1.1;
            -webkit-text-size-adjust: none;
            text-size-adjust: none;
        }

        .frustration-low { color: #4CAF50; }
        .frustration-medium { color: #FF9800; }
        .frustration-high { color: #F44336; }

        .daily-stats {
            display: flex;
            justify-content: space-around;
            gap: 6px;
            margin-top: 3px;
            position: relative;
            z-index: 2;
        }

        .stat-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.15);
            padding: 4px 6px;
            border-radius: 6px;
            flex: 1;
        }

        .stat-value {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 1px;
        }

        .stat-label {
            font-size: 9px;
            opacity: 0.9;
        }

        /* 24æ™‚é–“ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ - å…¨å¹…1è¡Œè¡¨ç¤º */
        .timeline-section {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 15px;
            border: 2px solid rgba(0, 255, 209, 0.5);
            box-shadow: 0 0 10px rgba(0, 255, 209, 0.3), inset 0 0 10px rgba(0, 255, 209, 0.05);
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            overflow: visible;
        }

        .timeline-container {
            position: relative;
            margin-top: 8px;
            padding: 40px 10px 3px 10px;
            background: rgba(50, 50, 50, 0.6);
            border-radius: 10px;
            height: 110px;
            overflow-x: hidden;
            overflow-y: visible;
            flex-shrink: 0;
        }

        .dice-timeline-container {
            position: relative;
            margin-top: 8px;
            padding: 40px 10px 3px 10px;
            background: rgba(50, 50, 50, 0.6);
            border: 2px solid rgba(0, 255, 209, 0.3);
            border-radius: 10px;
            height: 110px;
            overflow-x: hidden;
            overflow-y: visible;
            flex-shrink: 0;
        }

        .timeline-title {
            position: absolute;
            top: 2px;
            left: 10px;
            font-size: 12px;
            font-weight: bold;
            opacity: 0.8;
        }

        .timeline-activity {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 8px;
            margin: 4px;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
            flex-shrink: 0;
        }

        .timeline-activity:hover {
            transform: scale(1.02);
            z-index: 10;
            background: rgba(255, 255, 255, 0.3) !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .timeline-activity.low-stress { 
            background: rgba(76, 175, 80, 0.7); 
            border-color: #4CAF50;
        }
        .timeline-activity.medium-stress { 
            background: rgba(255, 152, 0, 0.7); 
            border-color: #FF9800;
        }
        .timeline-activity.high-stress { 
            background: rgba(244, 67, 54, 0.7); 
            border-color: #F44336;
        }

        .activity-info {
            text-align: center;
            font-size: 10px;
        }

        .activity-name {
            font-weight: bold;
            font-size: 11px;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .activity-time {
            font-size: 8px;
            opacity: 0.9;
            margin-bottom: 1px;
        }

        .activity-duration {
            font-size: 8px;
            opacity: 0.8;
        }

        .activity-frustration {
            font-size: 9px;
            font-weight: bold;
            margin-top: 2px;
        }

        /* æ™‚é–“è»¸ãƒ™ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ */
        .timeline-axis {
            position: absolute;
            top: 0;
            left: 10px;
            right: 10px;
            height: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
        }

        .hour-marker {
            position: absolute;
            height: 20px;
            width: 1px;
            background: rgba(255, 255, 255, 0.2);
            top: 0;
        }

        .hour-marker.major { /* 0, 3, 6, 9, 12, 15, 18, 21æ™‚ */
            background: rgba(255, 255, 255, 0.6);
            width: 3px;
        }

        .hour-label {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: rgba(255, 255, 255, 0.7);
            white-space: nowrap;
        }

        .hour-marker.major .hour-label {
            color: rgba(255, 255, 255, 0.95);
            font-weight: bold;
            font-size: 11px;
        }

        .timeline-activity-bar {
            position: absolute;
            bottom: 3px;
            height: 62px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            overflow: visible;
        }

        .timeline-activity-bar:hover {
            transform: translateY(-2px);
            z-index: 10;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        .timeline-activity-bar.low-stress {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.85), rgba(139, 195, 74, 0.85));
            border-color: #4CAF50;
        }

        .timeline-activity-bar.medium-stress {
            background: linear-gradient(135deg, rgba(255, 152, 0, 0.85), rgba(255, 193, 7, 0.85));
            border-color: #FF9800;
        }

        .timeline-activity-bar.high-stress {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.85), rgba(233, 30, 99, 0.85));
            border-color: #F44336;
        }

        .timeline-activity-bar.no-data {
            background: linear-gradient(135deg, rgba(150, 150, 150, 0.6), rgba(120, 120, 120, 0.6));
            border-color: #999;
            border-style: dashed;
        }

        .dice-suggestion-bar {
            position: absolute;
            bottom: 3px;
            height: 62px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px dashed rgba(76, 175, 80, 0.6);
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(139, 195, 74, 0.3));
            overflow: visible;
        }

        .dice-suggestion-bar:hover {
            transform: translateY(-2px);
            z-index: 10;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            border-color: #4CAF50;
        }

        .activity-bar-info {
            padding: 8px 6px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: center;
            color: white;
            text-shadow:
                0 0 3px rgba(255, 255, 255, 0.8),
                0 0 6px rgba(255, 255, 255, 0.6),
                0 0 9px rgba(255, 255, 255, 0.4),
                1px 1px 2px rgba(0, 0, 0, 0.7);
            gap: 3px;
        }

        .activity-bar-name {
            font-weight: bold;
            font-size: 13px;
            margin-bottom: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }

        /* çŸ­ã„æ´»å‹•ï¼šæ´»å‹•åã‚’ä¸Šéƒ¨ã‚¹ãƒšãƒ¼ã‚¹ã«2æ®µè¡¨ç¤º */
        /* 1æ®µç›®ï¼ˆä¸‹æ®µï¼‰ï¼šã‚³ãƒ³ãƒ†ãƒŠpaddingé ˜åŸŸå†…ã«é…ç½® */
        .timeline-activity-bar.narrow-activity .activity-bar-name,
        .dice-suggestion-bar.narrow-activity .activity-bar-name {
            position: absolute;
            top: -18px;
            left: 0;
            transform: none;
            padding: 2px 6px;
            border-radius: 4px;
            white-space: nowrap;
            z-index: 100;
            font-size: 9px;
            max-width: none;
            overflow: visible;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.8), 0 0 0 1px rgba(255, 255, 255, 0.2);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
        }

        /* 2æ®µç›®ï¼ˆä¸Šæ®µï¼‰ï¼š1æ®µç›®ã®ä¸Šã«é…ç½® */
        .timeline-activity-bar.narrow-activity.label-row-2 .activity-bar-name,
        .dice-suggestion-bar.narrow-activity.label-row-2 .activity-bar-name {
            top: -38px;
            z-index: 150;
        }

        /* æ ã¨ãƒ©ãƒ™ãƒ«ã‚’ç¹‹ãç·š */
        .timeline-activity-bar.narrow-activity::before,
        .dice-suggestion-bar.narrow-activity::before {
            content: '';
            position: absolute;
            left: 50%;
            top: -18px;
            width: 2px;
            height: 18px;
            background: currentColor;
            opacity: 0.7;
            z-index: 90;
        }

        .timeline-activity-bar.narrow-activity.label-row-2::before,
        .dice-suggestion-bar.narrow-activity.label-row-2::before {
            top: -38px;
            height: 38px;
            z-index: 140;
        }

        /* æ´»å‹•ã®ã‚¹ãƒˆãƒ¬ã‚¹ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸèƒŒæ™¯è‰² */
        .timeline-activity-bar.narrow-activity.low-stress .activity-bar-name {
            background: rgb(76, 175, 80);
            color: white;
        }

        .timeline-activity-bar.narrow-activity.medium-stress .activity-bar-name {
            background: rgb(255, 193, 7);
            color: white;
        }

        .timeline-activity-bar.narrow-activity.high-stress .activity-bar-name {
            background: rgb(244, 67, 54);
            color: white;
        }

        .timeline-activity-bar.narrow-activity.no-data .activity-bar-name {
            background: rgb(158, 158, 158);
            color: white;
        }

        /* DiCEã¯ç·‘è‰² */
        .dice-suggestion-bar.narrow-activity .activity-bar-name {
            background: rgb(76, 175, 80);
            color: white;
        }

        .activity-bar-time {
            font-size: 10px;
            opacity: 0.9;
            margin-bottom: 0;
            line-height: 1.1;
        }

        .activity-bar-frustration {
            font-size: 10px;
            font-weight: bold;
            margin-top: 0;
            line-height: 1.1;
        }

        .timeline-legend {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 10px;
            opacity: 0.7;
        }

        /* DiCEæ”¹å–„ææ¡ˆ - ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆåŒ– */
        /* DiCEæ”¹å–„ææ¡ˆ - ç‹­ãè¨­å®š */
        .dice-section {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 15px;
            border: 2px solid rgba(0, 255, 209, 0.5);
            box-shadow: 0 0 10px rgba(0, 255, 209, 0.3), inset 0 0 10px rgba(0, 255, 209, 0.05);
            flex: 0 0 250px;
            position: relative;
            overflow-y: auto;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .dice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .total-improvement {
            text-align: center;
            margin: 15px 0;
            font-size: 16px;
        }

        .improvement-value {
            font-size: 2.2em;
            font-weight: bold;
            color: #4CAF50;
            margin: 0 8px;
        }

        /* DiCEææ¡ˆãƒ†ãƒ¼ãƒ–ãƒ« - ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆæœ€é©åŒ–ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã—ï¼‰ */
        .suggestions-container {
            flex: 1;
            overflow: visible;
            padding-right: 5px;
            min-height: 0;
        }

        .suggestions-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            margin-top: 5px;
        }

        .suggestions-table thead {
            background: rgba(76, 175, 80, 0.2);
            border-bottom: 2px solid rgba(76, 175, 80, 0.4);
        }

        .suggestions-table th {
            padding: 5px 6px;
            text-align: left;
            font-weight: bold;
            color: white;
            font-size: 12px;
            border-bottom: 2px solid rgba(76, 175, 80, 0.3);
            white-space: nowrap;
        }

        .suggestions-table th:last-child {
            text-align: center;
            width: 70px;
        }

        .suggestions-table td {
            padding: 6px 6px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            vertical-align: middle;
        }

        .suggestions-table tr:last-child td {
            border-bottom: none;
        }

        .suggestions-table tbody tr {
            transition: background 0.2s ease;
        }

        .suggestions-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .table-time {
            font-weight: bold;
            color: white;
            font-size: 13px;
            white-space: nowrap;
            width: 55px;
        }

        .table-activity {
            font-size: 10px;
            line-height: 1.3;
            white-space: nowrap;
        }

        .table-current {
            color: #FF9800;
        }

        .table-arrow {
            color: rgba(255, 255, 255, 0.5);
            margin: 0 3px;
        }

        .table-suggested {
            color: white;
            font-weight: bold;
        }

        .table-improvement {
            text-align: center;
            font-weight: bold;
            color: #4CAF50;
            font-size: 16px;
            white-space: nowrap;
        }

        .no-suggestions-message {
            text-align: center;
            padding: 20px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
        }

        .top-n-indicator {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 3px;
            text-align: center;
        }

        /* ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³ - ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆåŒ– */
        /* ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚³ãƒ³ãƒ†ãƒŠï¼ˆå·¦å³ä¸¦åˆ—ï¼‰ */
        .feedback-container {
            display: flex;
            gap: 15px;
            flex: 1;
            min-height: 0;
        }

        .feedback-section {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 12px;
            border: 2px solid rgba(0, 255, 209, 0.5);
            box-shadow: 0 0 10px rgba(0, 255, 209, 0.3), inset 0 0 10px rgba(0, 255, 209, 0.05);
            flex: 1;
            position: relative;
            overflow-y: auto;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .feedback-section .section-title {
            margin-bottom: 5px;
        }

        .feedback-text {
            font-size: 13px;
            line-height: 1.6;
            margin-top: 0px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            position: relative;
            z-index: 2;
            flex: 1;
            overflow-y: auto;
            -webkit-text-size-adjust: none;
            text-size-adjust: none;
        }

        .feedback-highlight {
            color: #FFD700;
            font-weight: bold;
            text-shadow:
                0 0 4px rgba(255, 215, 0, 1),
                0 0 8px rgba(255, 215, 0, 0.8),
                0 0 12px rgba(255, 215, 0, 0.6),
                0 0 16px rgba(255, 215, 0, 0.4);
        }

        /* ã‚·ã‚¹ãƒ†ãƒ æƒ…å ± */
        .system-info {
            position: fixed;
            bottom: 15px;
            left: 20px;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #4CAF50;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º */
        .loading-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 30px;
            height: 30px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .loading-indicator.active {
            opacity: 1;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç‰¹åŒ–ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 1200px) and (min-width: 769px) {
            /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨èª¿æ•´ */
            .main-container {
                gap: 15px;
                padding: 15px;
            }
            
            .section-title {
                font-size: 20px;
            }
            
            .timeline-container,
            .dice-timeline-container {
                height: 90px;
            }
        }
        
        @media (max-width: 768px) {
            /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ç”¨ */
            .main-container {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }
            
            .visualization-panel,
            .feedback-panel {
                flex: none;
                max-width: none;
                height: auto;
            }
            
            .daily-stats {
                grid-template-columns: 1fr;
                gap: 5px;
            }
            
            .section-title {
                font-size: 16px;
            }
            
            .frustration-value {
                font-size: 2.8em;
            }
            
            .timeline-container,
            .dice-timeline-container {
                height: 70px;
            }
        }
        
        /* å¤§å‹ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ/ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ */
        @media (min-width: 1201px) {
            .main-container {
                max-width: 1400px;
                margin: 70px auto 0;
                padding: 25px;
                gap: 25px;
            }

            /* æ ã®ã‚µã‚¤ã‚ºã¯å°ã•ã„ç”»é¢ã¨åŒã˜ã«ä¿ã¤ */
            /* .daily-analysis { min-height: 320px; } ã‚’å‰Šé™¤ */

            .frustration-value {
                font-size: 3.5em;
            }
        }

        /* ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹æœ€é©åŒ– */
        @media (pointer: coarse) {
            .user-option, .suggestion-item {
                min-height: 48px; /* ã‚¿ãƒƒãƒã—ã‚„ã™ã„ã‚µã‚¤ã‚º */
                cursor: pointer;
            }

            .current-user-display {
                min-height: 48px;
                padding: 12px 20px;
            }

            .timeline-activity-bar,
            .dice-suggestion-bar {
                min-width: 30px; /* ã‚¿ãƒƒãƒã—ã‚„ã™ã„æœ€å°å¹… */
            }

            /* ã‚¿ãƒƒãƒæ™‚ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å¼·åŒ– */
            .suggestion-item:active {
                transform: scale(0.98);
                background: rgba(255, 255, 255, 0.25);
            }
        }

        /* ã€ä¸€æ™‚çš„ã€‘ãƒ‡ãƒãƒƒã‚°ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
        .debug-panel {
            position: fixed;
            bottom: 60px;
            right: 20px;
            background: rgba(244, 67, 54, 0.9);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 12px;
            border: 2px solid rgba(244, 67, 54, 0.5);
            z-index: 1000;
            display: none; /* ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«ã‚’éè¡¨ç¤º */
            flex-direction: column;
            gap: 10px;
            min-width: 200px;
        }

        .debug-label {
            font-size: 11px;
            font-weight: bold;
            color: #FFD700;
            text-align: center;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .debug-button {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .debug-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }

        .debug-button:active {
            transform: scale(0.95);
        }

        .debug-button:disabled {
            background: linear-gradient(135deg, #999, #888);
            cursor: not-allowed;
            transform: none;
        }

        .debug-status {
            font-size: 10px;
            text-align: center;
            color: white;
            padding: 5px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            min-height: 20px;
        }

        .debug-close {
            position: absolute;
            top: 5px;
            right: 8px;
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            opacity: 0.7;
            padding: 0;
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
        }

        .debug-close:hover {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
        <div class="logo">ğŸ§  ãƒ•ãƒ©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åˆ†æ</div>
        <div class="user-selector">
            <div class="current-user-display" onclick="toggleUserDropdown()">
                <div class="user-icon-small" id="current-user-icon">ğŸ‘¤</div>
                <span id="current-user-name">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</span>
                <span style="margin-left: 5px;">â–¼</span>
            </div>
        </div>
    </div>

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ -->
    <div class="user-dropdown" id="user-dropdown">
        <div class="user-option selected" data-user-id="default" onclick="selectUser('default', 'ğŸ‘¤', 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ')">
            <div class="user-icon-small">ğŸ‘¤</div>
            <span>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</span>
        </div>
        <div class="user-option" data-user-id="user1" onclick="selectUser('user1', 'ğŸ‘¨', 'å°æ‰‹å·')">
            <div class="user-icon-small">ğŸ‘¨</div>
            <span>å°æ‰‹å·</span>
        </div>
        <div class="user-option" data-user-id="user2" onclick="selectUser('user2', 'ğŸ‘©', 'æ¦æœ¬')">
            <div class="user-icon-small">ğŸ‘©</div>
            <span>æ¦æœ¬</span>
        </div>
        <div class="user-option" data-user-id="user3" onclick="selectUser('user3', 'ğŸ§‘', 'é•·å±±')">
            <div class="user-icon-small">ğŸ§‘</div>
            <span>é•·å±±</span>
        </div>
        <div class="user-option" data-user-id="user4" onclick="selectUser('user4', 'ğŸ‘¦', 'æŸ´ç”°')">
            <div class="user-icon-small">ğŸ‘¦</div>
            <span>æŸ´ç”°</span>
        </div>
        <div class="user-option" data-user-id="user5" onclick="selectUser('user5', 'ğŸ‘§', 'ç«¹ç”°')">
            <div class="user-icon-small">ğŸ‘§</div>
            <span>ç«¹ç”°</span>
        </div>
        <div class="user-option" data-user-id="user6" onclick="selectUser('user6', 'ğŸ§’', 'æ–°å')">
            <div class="user-icon-small">ğŸ§’</div>
            <span>æ–°å</span>
        </div>
        <div class="user-option" data-user-id="user7" onclick="selectUser('user7', 'ğŸ‘¨â€ğŸ¦±', 'å¯ºå²¡')">
            <div class="user-icon-small">ğŸ‘¨â€ğŸ¦±</div>
            <span>å¯ºå²¡</span>
        </div>
        <div class="user-option" data-user-id="user8" onclick="selectUser('user8', 'ğŸ‘©â€ğŸ¦±', 'å‰åœ°')">
            <div class="user-icon-small">ğŸ‘©â€ğŸ¦±</div>
            <span>å‰åœ°</span>
        </div>
        <div class="user-option" data-user-id="user9" onclick="selectUser('user9', 'ğŸ§‘â€ğŸ¦±', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼9')">
            <div class="user-icon-small">ğŸ§‘â€ğŸ¦±</div>
            <span>ãƒ¦ãƒ¼ã‚¶ãƒ¼9</span>
        </div>
    </div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ -->
    <div class="loading-indicator" id="loading-indicator"></div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="main-container">
        <!-- ä¸Šæ®µï¼šäºˆæ¸¬å€¤ãƒ»æ”¹å–„ææ¡ˆãƒ»ã‚¢ãƒ‰ãƒã‚¤ã‚¹ -->
        <div class="top-row">
            <!-- ä»Šæ—¥ã®ãƒ•ãƒ©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å€¤ -->
            <div class="daily-analysis">
                <h2 class="section-title">
                    <span class="section-icon">ğŸ”®</span>
                    äºˆæ¸¬å€¤
                </h2>

                <div class="daily-frustration">
                    <div class="frustration-value frustration-medium" id="daily-frustration-value">--</div>
                    <div style="font-size: 12px; opacity: 0.8;" id="daily-info">è¨ˆç®—ä¸­...</div>
                </div>

                <div class="daily-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="daily-min">--</div>
                        <div class="stat-label">æœ€å°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="daily-max">--</div>
                        <div class="stat-label">æœ€å¤§</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="daily-activities">--</div>
                        <div class="stat-label">æ´»å‹•</div>
                    </div>
                </div>
            </div>

            <!-- DiCEæ”¹å–„ææ¡ˆ -->
            <div class="dice-section">
                <h2 class="section-title" style="margin-bottom: 10px;">
                    <span class="section-icon">ğŸ¯</span>
                    æ”¹å–„ææ¡ˆ
                    <span style="margin-left: 10px; font-size: 14px; font-weight: normal; color: #4CAF50;">
                        åˆè¨ˆ: <span id="total-improvement" style="font-size: 1.3em; font-weight: bold;">--</span>ç‚¹
                    </span>
                </h2>

                <div class="suggestions-container" id="suggestions-container">
                    <table class="suggestions-table">
                        <thead>
                            <tr>
                                <th style="white-space: nowrap;">æ™‚åˆ»</th>
                                <th style="white-space: nowrap;">æ´»å‹•</th>
                                <th style="white-space: nowrap;">æ”¹å–„ç‚¹</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="3" style="text-align: center; padding: 15px; color: rgba(255,255,255,0.6);">
                                    åˆ†æä¸­...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼ˆå®Ÿé¨“æ¡ä»¶ã«ã‚ˆã‚Šå‹•çš„ã«åˆ‡ã‚Šæ›¿ãˆï¼‰ -->
            <div class="feedback-container">
                <div class="feedback-section">
                    <h2 class="section-title">
                        <span class="section-icon" id="feedback-icon">ğŸ’¬</span>
                        <span id="feedback-type-label">DiCEç‰ˆ</span>ã‚¢ãƒ‰ãƒã‚¤ã‚¹
                    </h2>
                    <div class="feedback-text" id="feedback-text">
                        ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ç”Ÿæˆä¸­ã§ã™...
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸‹æ®µï¼šã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å…¨å¹… -->
        <div class="bottom-row">
            <div class="timeline-section">
                <h2 class="section-title">
                    <span class="section-icon">â°</span>
                    ä»Šæ—¥ã®æ´»å‹•ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
                </h2>
                <div class="timeline-container" id="timeline-container">
                    <div class="timeline-title">å®Ÿéš›ã®æ´»å‹•</div>
                    <!-- 24æ™‚é–“åˆ†ã®è¦ç´ ãŒå‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                </div>
                <div class="timeline-legend" style="font-size: 9px;">
                    <span>0</span>
                    <span>3</span>
                    <span>6</span>
                    <span>9</span>
                    <span>12</span>
                    <span>15</span>
                    <span>18</span>
                    <span>21</span>
                    <span>24</span>
                </div>

                <div class="dice-timeline-container" id="dice-timeline-container">
                    <div class="timeline-title">DiCEæ”¹å–„ææ¡ˆ</div>
                    <!-- DiCEææ¡ˆãŒå‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                </div>
                <div class="timeline-legend" style="font-size: 9px;">
                    <span>0</span>
                    <span>3</span>
                    <span>6</span>
                    <span>9</span>
                    <span>12</span>
                    <span>15</span>
                    <span>18</span>
                    <span>21</span>
                    <span>24</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚·ã‚¹ãƒ†ãƒ æƒ…å ± -->
    <div class="system-info">
        <div class="status-dot"></div>
        <span id="update-status">è‡ªå‹•æ›´æ–°ä¸­</span>
        <span>|</span>
        <span id="last-update">æœ€çµ‚æ›´æ–°: --:--</span>
        <span>|</span>
        <span>æ¬¡å›DiCE: <span id="next-dice">--:--</span></span>
    </div>

    <!-- ã€ä¸€æ™‚çš„ã€‘ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ« -->
    <div class="debug-panel" id="debug-panel">
        <button class="debug-close" onclick="closeDebugPanel()" title="ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹">Ã—</button>
        <div class="debug-label">ğŸ› ï¸ DEBUG MODE</div>
        <button class="debug-button" id="manual-dice-button" onclick="triggerManualDiCE()">
            ğŸ² DiCEåˆ†æã‚’å®Ÿè¡Œ
        </button>
        <div class="debug-status" id="debug-status">å¾…æ©Ÿä¸­</div>
    </div>

    <script>
        // ========== å®Ÿé¨“è¨­å®š ==========
        const EXPERIMENT_CONFIG = {
            startDate: '2025-11-19',  // å®Ÿé¨“é–‹å§‹æ—¥
            groupA: ['user5', 'user6', 'user7', 'user8'],  // å‰åŠDiCE â†’ å¾ŒåŠæ¨å®šå€¤ã®ã¿
            groupB: ['default', 'user1', 'user2', 'user3', 'user4']   // å‰åŠæ¨å®šå€¤ã®ã¿ â†’ å¾ŒåŠDiCE
        };

        /**
         * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨æ—¥ä»˜ã‹ã‚‰DiCEç‰ˆã‚’è¡¨ç¤ºã™ã¹ãã‹åˆ¤å®š
         */
        function shouldShowDiCE(userId) {
            const now = new Date();
            const hour = now.getHours();

            // 9æ™‚å‰ã¯å‰æ—¥ã¨ã—ã¦æ‰±ã†ï¼ˆgetFeedbackDate()ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
            let targetDate = new Date(now);
            if (hour < 9) {
                targetDate.setDate(targetDate.getDate() - 1);
            }

            // ãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜ã¨ã—ã¦æ¯”è¼ƒã™ã‚‹ãŸã‚ã€æ™‚åˆ»ã‚’0:00:00ã«ãƒªã‚»ãƒƒãƒˆ
            targetDate.setHours(0, 0, 0, 0);

            // å®Ÿé¨“é–‹å§‹æ—¥ã‚’ãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜ã¨ã—ã¦è§£é‡ˆ
            const [year, month, day] = EXPERIMENT_CONFIG.startDate.split('-');
            const startDate = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
            startDate.setHours(0, 0, 0, 0);

            const daysSinceStart = Math.floor((targetDate - startDate) / (1000 * 60 * 60 * 24));

            // å®Ÿé¨“æœŸé–“å¤–ï¼ˆ0æ—¥ç›®ã‚ˆã‚Šå‰ã€ã¾ãŸã¯6æ—¥ç›®ä»¥é™ï¼‰
            if (daysSinceStart < 0 || daysSinceStart >= 6) {
                console.log(`ğŸ“… å®Ÿé¨“æœŸé–“å¤–ï¼ˆ${daysSinceStart}æ—¥ç›®ï¼‰: DiCEç‰ˆã‚’è¡¨ç¤º`);
                return true;  // å®Ÿé¨“æœŸé–“å¤–ã¯DiCEç‰ˆã‚’è¡¨ç¤º
            }

            const isFirstHalf = daysSinceStart < 3;  // 0-2æ—¥ç›® = å‰åŠ

            // ã‚°ãƒ«ãƒ¼ãƒ—A: å‰åŠDiCE â†’ å¾ŒåŠæ¨å®šå€¤ã®ã¿
            if (EXPERIMENT_CONFIG.groupA.includes(userId)) {
                const showDice = isFirstHalf;
                console.log(`ğŸ“… ${userId} (ã‚°ãƒ«ãƒ¼ãƒ—A), ${daysSinceStart}æ—¥ç›® (${isFirstHalf ? 'å‰åŠ' : 'å¾ŒåŠ'}): ${showDice ? 'DiCEç‰ˆ' : 'æ¨å®šå€¤ã®ã¿ç‰ˆ'}`);
                return showDice;
            }

            // ã‚°ãƒ«ãƒ¼ãƒ—B: å‰åŠæ¨å®šå€¤ã®ã¿ â†’ å¾ŒåŠDiCE
            if (EXPERIMENT_CONFIG.groupB.includes(userId)) {
                const showDice = !isFirstHalf;
                console.log(`ğŸ“… ${userId} (ã‚°ãƒ«ãƒ¼ãƒ—B), ${daysSinceStart}æ—¥ç›® (${isFirstHalf ? 'å‰åŠ' : 'å¾ŒåŠ'}): ${showDice ? 'DiCEç‰ˆ' : 'æ¨å®šå€¤ã®ã¿ç‰ˆ'}`);
                return showDice;
            }

            // ãã®ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆå®Ÿé¨“å¯¾è±¡å¤–ï¼‰
            console.log(`ğŸ“… ${userId} (å®Ÿé¨“å¯¾è±¡å¤–): DiCEç‰ˆã‚’è¡¨ç¤º`);
            return true;
        }

        // ã€æ¤œè¨¼ç”¨ã€‘è¡¨ç¤ºæ™‚é–“ã®è¨­å®šï¼ˆã“ã“ã‚’å¤‰æ›´ã—ã¦æ¤œè¨¼å¯èƒ½ï¼‰
        const DISPLAY_TIMES = [
            { start: 22, end: 25, startMinute: 50 },  // 22:50-25:00ï¼ˆç¿Œ1:00ï¼‰- æ¤œè¨¼ç”¨
            { start: 6, end: 9, startMinute: 0 }      // 6:00-9:00
        ];

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentUser = localStorage.getItem('selectedUser') || 'default'; // localStorageã‹ã‚‰å¾©å…ƒ
        let dataUpdateInterval = 300000; // 5åˆ†ã”ã¨ã«ãƒ‡ãƒ¼ã‚¿æ›´æ–°
        let diceUpdateInterval = 3600000; // 1æ™‚é–“ã”ã¨ã«DiCEåˆ†æ
        let lastDiceUpdate = 0;
        let lastActivityCount = 0;

        // ç”»é¢ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢ç”¨ã®Wake Lock API
        let wakeLock = null;

        // ç¾åœ¨æ™‚åˆ»ãŒè¡¨ç¤ºæ™‚é–“å†…ã‹ãƒã‚§ãƒƒã‚¯
        function isDisplayTime() {
            // ã€ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–ã€‘å¸¸ã«è¡¨ç¤º
            return true;

            /* å…ƒã®ã‚³ãƒ¼ãƒ‰ï¼ˆå†æœ‰åŠ¹åŒ–ã™ã‚‹å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆè§£é™¤ï¼‰
            const now = new Date();
            const hour = now.getHours();
            const minute = now.getMinutes();

            for (const timeRange of DISPLAY_TIMES) {
                const startHour = timeRange.start;
                const startMinute = timeRange.startMinute || 0;
                const endHour = timeRange.end;

                // 25æ™‚ï¼ˆç¿Œ1æ™‚ï¼‰ãªã©ã®å‡¦ç†
                if (endHour > 24) {
                    // æ—¥ã‚’ã¾ãŸãå ´åˆ
                    if (hour >= startHour || hour < (endHour - 24)) {
                        // é–‹å§‹æ™‚åˆ»ã®åˆ†ãƒã‚§ãƒƒã‚¯
                        if (hour === startHour && minute < startMinute) {
                            continue;
                        }
                        return true;
                    }
                } else {
                    // é€šå¸¸ã®æ™‚é–“ç¯„å›²
                    if (hour >= startHour && hour < endHour) {
                        // é–‹å§‹æ™‚åˆ»ã®åˆ†ãƒã‚§ãƒƒã‚¯
                        if (hour === startHour && minute < startMinute) {
                            continue;
                        }
                        return true;
                    }
                }
            }
            return false;
            */
        }

        // å¾…æ©Ÿç”»é¢ã‚’è¡¨ç¤º
        function showWaitingScreen() {
            const body = document.body;
            body.style.background = '#000';
            body.innerHTML = `
                <div style="display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; color: #666; font-size: 24px;">
                    <div style="margin-bottom: 20px;">â°</div>
                    <div>è¡¨ç¤ºæ™‚é–“å¤–ã§ã™</div>
                    <div style="font-size: 16px; margin-top: 10px;">æ¬¡ã®è¡¨ç¤ºæ™‚é–“: 22:50-1:00, 6:00-9:00</div>
                </div>
            `;
            console.log('â° è¡¨ç¤ºæ™‚é–“å¤–ã®ãŸã‚å¾…æ©Ÿä¸­...');
        }

        // Wake Lockã‚’å–å¾—ã—ã¦ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢
        async function preventScreenSleep() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('ğŸ”‹ ç”»é¢ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢: æœ‰åŠ¹');

                    wakeLock.addEventListener('release', () => {
                        console.log('ğŸ”‹ ç”»é¢ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢: è§£é™¤');
                    });
                } else {
                    console.warn('âš ï¸ Wake Lock APIã¯ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šå®šæœŸçš„ã«ç”»é¢ã‚’æ›´æ–°
                    setInterval(() => {
                        document.body.style.opacity = 0.9999;
                        setTimeout(() => { document.body.style.opacity = 1; }, 100);
                    }, 30000); // 30ç§’ã”ã¨
                }
            } catch (err) {
                console.error('Wake Lockå–å¾—ã‚¨ãƒ©ãƒ¼:', err);
            }
        }

        // ãƒšãƒ¼ã‚¸ãŒå†ã³è¡¨ç¤ºã•ã‚ŒãŸã¨ãã«Wake Lockã‚’å†å–å¾—
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                await preventScreenSleep();
            }
        });

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è¡¨ç¤ºæ™‚é–“ãƒã‚§ãƒƒã‚¯
            if (isDisplayTime()) {
                console.log('âœ… è¡¨ç¤ºæ™‚é–“å†… - ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¾ã™');
                initializeSystem();
                startAutoUpdate();
                startDiCEScheduler();
                preventScreenSleep(); // ç”»é¢ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢ã‚’é–‹å§‹

                // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹ãŸã‚ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                document.addEventListener('click', function(event) {
                    if (!event.target.closest('.user-selector')) {
                        closeUserDropdown();
                    }
                });
            } else {
                console.log('â° è¡¨ç¤ºæ™‚é–“å¤– - å¾…æ©Ÿç”»é¢ã‚’è¡¨ç¤ºã—ã¾ã™');
                showWaitingScreen();

                // 1åˆ†ã”ã¨ã«æ™‚åˆ»ã‚’ãƒã‚§ãƒƒã‚¯
                setInterval(() => {
                    if (isDisplayTime()) {
                        console.log('âœ… è¡¨ç¤ºæ™‚é–“ã«ãªã‚Šã¾ã—ãŸ - ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™');
                        location.reload();
                    }
                }, 60000); // 60ç§’ã”ã¨
            }
        });

        // ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
        function initializeSystem() {
            console.log('ğŸ® ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...');

            // localStorageã‹ã‚‰å¾©å…ƒã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã§UIã‚’æ›´æ–°
            restoreUserUI();

            // å®Ÿé¨“æ¡ä»¶ã«å¿œã˜ãŸè¡¨ç¤ºã‚’æ›´æ–°
            updateExperimentView(currentUser);

            loadUserData(currentUser);
        }

        // ä¿å­˜ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã§UIã‚’å¾©å…ƒ
        function restoreUserUI() {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒƒãƒ”ãƒ³ã‚°
            const userMap = {
                'default': { icon: 'ğŸ‘¤', name: 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ' },
                'user1': { icon: 'ğŸ‘¨', name: 'å°æ‰‹å·' },
                'user2': { icon: 'ğŸ‘©', name: 'æ¦æœ¬' },
                'user3': { icon: 'ğŸ§‘', name: 'é•·å±±' },
                'user4': { icon: 'ğŸ‘¦', name: 'æŸ´ç”°' },
                'user5': { icon: 'ğŸ‘§', name: 'ç«¹ç”°' },
                'user6': { icon: 'ğŸ§’', name: 'æ–°å' },
                'user7': { icon: 'ğŸ‘¨â€ğŸ¦±', name: 'å¯ºå²¡' },
                'user8': { icon: 'ğŸ‘©â€ğŸ¦±', name: 'å‰åœ°' },
                'user9': { icon: 'ğŸ§‘â€ğŸ¦±', name: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼9' }
            };

            const userInfo = userMap[currentUser] || userMap['default'];

            // ãƒ˜ãƒƒãƒ€ãƒ¼ã®UIã‚’æ›´æ–°
            document.getElementById('current-user-icon').textContent = userInfo.icon;
            document.getElementById('current-user-name').textContent = userInfo.name;

            // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.user-option').forEach(option => {
                option.classList.remove('selected');
            });
            const selectedOption = document.querySelector(`[data-user-id="${currentUser}"]`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }

            console.log(`ğŸ”„ ãƒ¦ãƒ¼ã‚¶ãƒ¼UIå¾©å…ƒ: ${currentUser} (${userInfo.name})`);
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function toggleUserDropdown() {
            const dropdown = document.getElementById('user-dropdown');
            dropdown.classList.toggle('active');
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹
        function closeUserDropdown() {
            const dropdown = document.getElementById('user-dropdown');
            dropdown.classList.remove('active');
        }

        /**
         * å®Ÿé¨“æ¡ä»¶ã«åŸºã¥ã„ã¦è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
         */
        function updateExperimentView(userId) {
            const showDice = shouldShowDiCE(userId);

            // DiCEæ”¹å–„ææ¡ˆã®æ ã®è¡¨ç¤º/éè¡¨ç¤º
            const diceSection = document.querySelector('.dice-section');
            if (diceSection) {
                diceSection.style.display = showDice ? 'block' : 'none';
            }

            // DiCEæ”¹å–„ææ¡ˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤º
            const diceTimeline = document.getElementById('dice-timeline-container');
            if (diceTimeline) {
                diceTimeline.style.display = showDice ? 'block' : 'none';
                // æ¬¡ã®.timeline-legendï¼ˆDiCEã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”¨ï¼‰ã‚‚éè¡¨ç¤º
                const nextLegend = diceTimeline.nextElementSibling;
                if (nextLegend && nextLegend.classList.contains('timeline-legend')) {
                    nextLegend.style.display = showDice ? 'flex' : 'none';
                }
            }

            // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ ã®ãƒ©ãƒ™ãƒ«ã¨ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
            const feedbackIcon = document.getElementById('feedback-icon');
            const feedbackLabel = document.getElementById('feedback-type-label');

            if (showDice) {
                if (feedbackIcon) feedbackIcon.textContent = 'ğŸ’¬';
                if (feedbackLabel) feedbackLabel.textContent = 'DiCEç‰ˆ';
            } else {
                if (feedbackIcon) feedbackIcon.textContent = 'ğŸ’­';
                if (feedbackLabel) feedbackLabel.textContent = 'æ¨å®šå€¤ã®ã¿';
            }

            console.log(`ğŸ¨ å®Ÿé¨“è¡¨ç¤ºæ›´æ–°: ${showDice ? 'DiCEç‰ˆ' : 'æ¨å®šå€¤ã®ã¿ç‰ˆ'}`);
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠ
        function selectUser(userId, icon, name) {
            if (userId === currentUser) {
                closeUserDropdown();
                return;
            }
            
            console.log(`ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼å¤‰æ›´: ${currentUser} â†’ ${userId}`);
            
            // UIæ›´æ–°
            document.getElementById('current-user-icon').textContent = icon;
            document.getElementById('current-user-name').textContent = name;
            
            // é¸æŠçŠ¶æ…‹æ›´æ–°
            document.querySelectorAll('.user-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector(`[data-user-id="${userId}"]`).classList.add('selected');

            currentUser = userId;
            localStorage.setItem('selectedUser', userId); // localStorageã«ä¿å­˜
            console.log(`ğŸ’¾ ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠã‚’ä¿å­˜: ${userId}`);
            closeUserDropdown();

            // å®Ÿé¨“æ¡ä»¶ã«å¿œã˜ãŸè¡¨ç¤ºã‚’æ›´æ–°
            updateExperimentView(userId);

            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            loadUserData(userId);
        }

        // è‡ªå‹•ãƒ‡ãƒ¼ã‚¿æ›´æ–°é–‹å§‹
        function startAutoUpdate() {
            // å³åº§ã«ä¸€åº¦å®Ÿè¡Œ
            loadUserData(currentUser);
            
            // å®šæœŸæ›´æ–°
            setInterval(() => {
                loadUserData(currentUser);
            }, dataUpdateInterval);
        }

        // DiCEã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼é–‹å§‹
        function startDiCEScheduler() {
            // 1æ™‚é–“ã”ã¨ã®DiCEå®Ÿè¡Œ
            setInterval(() => {
                executeDiCEAnalysis(currentUser);
            }, diceUpdateInterval);
            
            // åˆå›DiCEå®Ÿè¡Œï¼ˆ10ç§’å¾Œï¼‰
            setTimeout(() => {
                executeDiCEAnalysis(currentUser);
            }, 10000);
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadUserData(userId) {
            console.log(`ğŸ“Š ãƒ‡ãƒ¼ã‚¿æ›´æ–°é–‹å§‹: ${userId}`);
            showLoading(true);
            
            try {
                // ä¸¦è¡Œã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                await Promise.all([
                    loadDailyFrustration(userId),
                    loadTimeline(userId),
                    loadFeedback(userId)
                ]);
                
                // æ´»å‹•æ•°ãŒå¢—ãˆãŸå ´åˆã¯DiCEåˆ†æã‚’å®Ÿè¡Œ
                await checkForNewActivities(userId);
                
                updateLastUpdateTime();
                updateNextDiCETime();
                
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showErrorState();
            } finally {
                showLoading(false);
            }
        }

        // ä»Šæ—¥ã®ãƒ•ãƒ©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å€¤èª­ã¿è¾¼ã¿ï¼ˆäºˆæ¸¬å€¤ãƒ™ãƒ¼ã‚¹ï¼‰
        async function loadDailyFrustration(userId) {
            try {
                const targetDate = getFeedbackDate();
                console.log(`ğŸ“… ãƒ•ãƒ©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³äºˆæ¸¬å€¤å–å¾—æ—¥ä»˜: ${targetDate}`);

                // ã¾ãšæ´»å‹•ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const response = await fetch('/api/frustration/timeline', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        date: targetDate
                    })
                });

                const data = await response.json();

                if (data.status === 'success' && data.timeline.length > 0) {
                    // å„æ´»å‹•ã«å¯¾ã—ã¦ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ äºˆæ¸¬ã‚’å®Ÿè¡Œ
                    await updateDailyFrustrationWithPredictions(data.timeline, userId);
                }
            } catch (error) {
                console.error('æ—¥æ¬¡ãƒ•ãƒ©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å€¤å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // äºˆæ¸¬å€¤ãƒ™ãƒ¼ã‚¹ã§æ—¥æ¬¡ãƒ•ãƒ©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤ºã‚’æ›´æ–°
        async function updateDailyFrustrationWithPredictions(timeline, userId) {
            const predictedTimeline = [];
            
            // å„æ´»å‹•ã«å¯¾ã—ã¦äºˆæ¸¬ã‚’å®Ÿè¡Œ
            for (const item of timeline) {
                try {
                    const response = await fetch('/api/frustration/predict-activity', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_id: userId,
                            activity_category: item.activity,
                            duration: item.duration || 60,
                            timestamp: item.timestamp
                        })
                    });
                    
                    const predictionData = await response.json();
                    
                    if (predictionData.status === 'success') {
                        predictedTimeline.push({
                            ...item,
                            frustration_value: predictionData.predicted_frustration,
                            is_predicted: true,
                            confidence: predictionData.confidence || 0
                        });
                    } else {
                        // äºˆæ¸¬ã«å¤±æ•—ã—ãŸå ´åˆã¯nullã®ã¾ã¾ï¼ˆè¡¨ç¤ºã—ãªã„ï¼‰
                        predictedTimeline.push({
                            ...item,
                            frustration_value: item.frustration_value || null,
                            is_predicted: false,
                            confidence: 0
                        });
                    }
                } catch (error) {
                    console.error('æ´»å‹•äºˆæ¸¬ã‚¨ãƒ©ãƒ¼:', error);
                    // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯nullã®ã¾ã¾ï¼ˆè¡¨ç¤ºã—ãªã„ï¼‰
                    predictedTimeline.push({
                        ...item,
                        frustration_value: item.frustration_value || null,
                        is_predicted: false,
                        confidence: 0
                    });
                }
            }
            
            updateDailyFrustrationDisplay(predictedTimeline);
        }

        // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³èª­ã¿è¾¼ã¿ï¼ˆäºˆæ¸¬å€¤ãƒ™ãƒ¼ã‚¹æ´»å‹•è¡¨ç¤ºï¼‰
        async function loadTimeline(userId) {
            try {
                const targetDate = getFeedbackDate();
                console.log(`ğŸ“… ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å–å¾—æ—¥ä»˜: ${targetDate}`);

                const response = await fetch('/api/frustration/timeline', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        date: targetDate
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    // äºˆæ¸¬å€¤ã§ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤ºã‚’æ›´æ–°
                    await updateTimelineWithPredictions(data.timeline, userId);

                    // æ´»å‹•æ•°ã‚’ãƒã‚§ãƒƒã‚¯
                    const currentActivityCount = data.timeline.length;
                    if (currentActivityCount > lastActivityCount) {
                        lastActivityCount = currentActivityCount;
                        console.log(`ğŸ¯ æ–°ã—ã„æ´»å‹•ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ: ${currentActivityCount - lastActivityCount}ä»¶`);

                        // æ–°ã—ã„æ´»å‹•ãŒå ±å‘Šã•ã‚ŒãŸå ´åˆã€DiCEåˆ†æã‚’å®Ÿè¡Œ
                        setTimeout(() => {
                            executeDiCEAnalysis(userId);
                        }, 5000); // 5ç§’å¾Œã«å®Ÿè¡Œ
                    }
                }
            } catch (error) {
                console.error('ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // äºˆæ¸¬å€¤ã§ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤ºã‚’æ›´æ–°
        async function updateTimelineWithPredictions(timeline, userId) {
            if (timeline.length === 0) {
                updateTimelineDisplay([]);
                return;
            }

            const predictedTimeline = [];
            
            // å„æ´»å‹•ã«å¯¾ã—ã¦äºˆæ¸¬ã‚’å®Ÿè¡Œ
            for (const item of timeline) {
                try {
                    const response = await fetch('/api/frustration/predict-activity', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_id: userId,
                            activity_category: item.activity,
                            duration: item.duration || 60,
                            timestamp: item.timestamp
                        })
                    });
                    
                    const predictionData = await response.json();
                    
                    if (predictionData.status === 'success') {
                        predictedTimeline.push({
                            ...item,
                            frustration_value: predictionData.predicted_frustration,
                            is_predicted: true,
                            confidence: predictionData.confidence || 0
                        });
                    } else {
                        // äºˆæ¸¬ã«å¤±æ•—ã—ãŸå ´åˆã¯nullã®ã¾ã¾ï¼ˆè¡¨ç¤ºã—ãªã„ï¼‰
                        predictedTimeline.push({
                            ...item,
                            frustration_value: item.frustration_value || null,
                            is_predicted: false,
                            confidence: 0
                        });
                    }
                } catch (error) {
                    console.error('æ´»å‹•äºˆæ¸¬ã‚¨ãƒ©ãƒ¼:', error);
                    // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯nullã®ã¾ã¾ï¼ˆè¡¨ç¤ºã—ãªã„ï¼‰
                    predictedTimeline.push({
                        ...item,
                        frustration_value: item.frustration_value || null,
                        is_predicted: false,
                        confidence: 0
                    });
                }
            }
            
            updateTimelineDisplay(predictedTimeline);
        }

        // æ–°ã—ã„æ´»å‹•ã‚’ãƒã‚§ãƒƒã‚¯
        async function checkForNewActivities(userId) {
            // loadTimelineå†…ã§å‡¦ç†
        }

        // DiCEåˆ†æå®Ÿè¡Œ
        async function executeDiCEAnalysis(userId) {
            console.log(`ğŸ² DiCEåˆ†æå®Ÿè¡Œ: ${userId}`);

            try {
                const response = await fetch('/api/frustration/dice-analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        lookback_hours: 24
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    updateDiCEDisplay(data.dice_analysis);
                    lastDiceUpdate = Date.now();
                }
            } catch (error) {
                console.error('DiCEåˆ†æã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤ºç”¨ã®æ—¥ä»˜ã‚’å–å¾—ï¼ˆ9æ™‚ã¾ã§å‰æ—¥ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¡¨ç¤ºï¼‰
        function getFeedbackDate() {
            const now = new Date();
            const hour = now.getHours();

            // 0:00 ï½ 8:59 ã®å ´åˆã¯å‰æ—¥ã®æ—¥ä»˜ã‚’è¿”ã™
            if (hour < 9) {
                const yesterday = new Date(now);
                yesterday.setDate(yesterday.getDate() - 1);
                // ãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜ã‚’ YYYY-MM-DD å½¢å¼ã§è¿”ã™
                const year = yesterday.getFullYear();
                const month = String(yesterday.getMonth() + 1).padStart(2, '0');
                const day = String(yesterday.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // 9:00 ä»¥é™ã¯å½“æ—¥ã®æ—¥ä»˜ã‚’è¿”ã™ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜ï¼‰
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯èª­ã¿è¾¼ã¿
        async function loadFeedback(userId) {
            try {
                const hour = new Date().getHours();
                const feedbackType = (hour >= 5 && hour < 12) ? 'morning' : 'evening';
                const feedbackDate = getFeedbackDate();

                console.log(`ğŸ“… ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å–å¾—æ—¥ä»˜: ${feedbackDate} (ç¾åœ¨æ™‚åˆ»: ${hour}æ™‚)`);

                const response = await fetch('/api/feedback/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        type: feedbackType,
                        date: feedbackDate
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    updateFeedbackDisplay(data.feedback, feedbackType);
                }
            } catch (error) {
                console.error('ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ä»Šæ—¥ã®ãƒ•ãƒ©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤ºæ›´æ–°
        function updateDailyFrustrationDisplay(timeline) {
            if (!timeline || timeline.length === 0) return;

            // ä»Šæ—¥ã®çµ±è¨ˆã‚’è¨ˆç®—ï¼ˆfrustration_valueãŒnullã§ãªã„ã‚‚ã®ã ã‘ï¼‰
            const frustrationValues = timeline
                .filter(item => item.frustration_value != null)
                .map(item => item.frustration_value);

            if (frustrationValues.length === 0) {
                // äºˆæ¸¬å€¤ãŒ1ã¤ã‚‚ãªã„å ´åˆ
                document.getElementById('daily-frustration-value').textContent = '--';
                document.getElementById('daily-info').textContent = 'äºˆæ¸¬å€¤ãªã—';
                document.getElementById('daily-min').textContent = '--';
                document.getElementById('daily-max').textContent = '--';
                document.getElementById('daily-activities').textContent = 0;
                return;
            }

            const average = frustrationValues.reduce((sum, val) => sum + val, 0) / frustrationValues.length;
            const min = Math.min(...frustrationValues);
            const max = Math.max(...frustrationValues);

            // è¡¨ç¤ºæ›´æ–°ï¼ˆ1-20ã‚¹ã‚±ãƒ¼ãƒ«å¯¾å¿œï¼‰
            const valueElement = document.getElementById('daily-frustration-value');
            valueElement.textContent = Math.round(average);
            valueElement.className = 'frustration-value ' +
                (average <= 6 ? 'frustration-low' :
                 average <= 13 ? 'frustration-medium' : 'frustration-high');

            document.getElementById('daily-info').textContent =
                `ä»Šæ—¥ã®äºˆæ¸¬å¹³å‡å€¤ (${frustrationValues.length}å›ã®æ´»å‹•)`;

            document.getElementById('daily-min').textContent = Math.round(min);
            document.getElementById('daily-max').textContent = Math.round(max);
            document.getElementById('daily-activities').textContent = frustrationValues.length;
        }

        // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤ºæ›´æ–°ï¼ˆæ™‚é–“è»¸ãƒ™ãƒ¼ã‚¹ï¼‰
        function updateTimelineDisplay(timeline) {
            const container = document.getElementById('timeline-container');
            container.innerHTML = '';

            if (timeline.length === 0) return;

            // æ´»å‹•ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã—ã¦æ™‚é–“è»¸ã«é…ç½®
            const processedActivities = processActivitiesForTimeline(timeline);
            
            // æ™‚é–“è»¸ã‚’ä½œæˆï¼ˆ0:00-23:59ã®24æ™‚é–“ï¼‰
            createTimelineAxis(container, processedActivities);
        }

        // æ´»å‹•ãƒ‡ãƒ¼ã‚¿ã‚’æ™‚é–“è»¸ç”¨ã«å‡¦ç†
        function processActivitiesForTimeline(timeline) {
            const processed = [];

            timeline.forEach(item => {
                const startTime = new Date(item.timestamp);
                const durationMinutes = item.duration || 0;
                const endTime = new Date(startTime.getTime() + durationMinutes * 60000);

                // æ—¥ã‚’ã¾ãŸãæ´»å‹•ã®å‡¦ç†ï¼šãã®æ—¥ã®00:00ä»¥é™ã®ã¿è¡¨ç¤º
                const todayStart = new Date(endTime);
                todayStart.setHours(0, 0, 0, 0);  // ãã®æ—¥ã®00:00

                let displayStartTime = startTime;
                let displayDuration = durationMinutes;

                // é–‹å§‹æ™‚åˆ»ãŒå‰æ—¥ï¼ˆ00:00ã‚ˆã‚Šå‰ï¼‰ã®å ´åˆã€00:00ã«åˆ‡ã‚Šè©°ã‚ã‚‹
                if (startTime < todayStart) {
                    displayStartTime = new Date(todayStart);
                    // ç¶™ç¶šæ™‚é–“ã‚’èª¿æ•´ï¼ˆ00:00ã‹ã‚‰çµ‚äº†æ™‚åˆ»ã¾ã§ã®æ™‚é–“ï¼‰
                    displayDuration = Math.floor((endTime - todayStart) / 60000);
                }

                processed.push({
                    activity: item.activity,
                    startTime: displayStartTime,  // è¡¨ç¤ºç”¨ã®é–‹å§‹æ™‚åˆ»
                    endTime: endTime,
                    durationMinutes: displayDuration,  // è¡¨ç¤ºç”¨ã®ç¶™ç¶šæ™‚é–“
                    frustration: item.frustration_value,  // nullã®å ´åˆã‚‚ãã®ã¾ã¾ä¿æŒ
                    startHour: displayStartTime.getHours(),
                    startMinute: displayStartTime.getMinutes(),
                    endHour: endTime.getHours(),
                    endMinute: endTime.getMinutes(),
                    originalStartTime: startTime  // å…ƒã®é–‹å§‹æ™‚åˆ»ã¯ä¿æŒ
                });
            });

            // é€£ç¶šã—ãŸåŒã˜æ´»å‹•ã‚’ãƒãƒ¼ã‚¸
            return mergeConsecutiveTimelineActivities(processed);
        }

        // æ™‚é–“è»¸ãƒ™ãƒ¼ã‚¹ã§ã®é€£ç¶šæ´»å‹•ãƒãƒ¼ã‚¸
        function mergeConsecutiveTimelineActivities(activities) {
            if (activities.length === 0) return [];
            
            // é–‹å§‹æ™‚é–“ã§ã‚½ãƒ¼ãƒˆ
            const sorted = activities.sort((a, b) => a.startTime - b.startTime);
            const merged = [];
            let currentGroup = null;

            sorted.forEach(activity => {
                if (!currentGroup || 
                    currentGroup.activity !== activity.activity ||
                    Math.abs(currentGroup.endTime - activity.startTime) > 60000) { // 1åˆ†ä»¥ä¸Šã®å·®ãŒã‚ã‚Œã°åˆ¥ã‚°ãƒ«ãƒ¼ãƒ—
                    
                    if (currentGroup) {
                        merged.push(currentGroup);
                    }
                    
                    currentGroup = {
                        activity: activity.activity,
                        startTime: activity.startTime,
                        endTime: activity.endTime,
                        durationMinutes: activity.durationMinutes,
                        frustrationValues: [activity.frustration],
                        avgFrustration: activity.frustration
                    };
                } else {
                    // åŒã˜æ´»å‹•ã§é€£ç¶šã—ã¦ã„ã‚‹å ´åˆã¯ãƒãƒ¼ã‚¸
                    currentGroup.endTime = activity.endTime;
                    currentGroup.durationMinutes += activity.durationMinutes;
                    currentGroup.frustrationValues.push(activity.frustration);
                    currentGroup.avgFrustration = currentGroup.frustrationValues.reduce((sum, val) => sum + val, 0) / currentGroup.frustrationValues.length;
                }
            });

            if (currentGroup) {
                merged.push(currentGroup);
            }

            return merged;
        }

        // æ™‚é–“è»¸ã‚’ä½œæˆ
        function createTimelineAxis(container, activities) {
            // æ´»å‹•ãƒãƒ¼ã‚’é…ç½®ï¼ˆãƒ¡ãƒ¢ãƒªãªã—ï¼‰
            let narrowIndex = 0;
            activities.forEach(activity => {
                const activityBar = createActivityBar(activity, narrowIndex);
                container.appendChild(activityBar);

                // narrow-activityã®å ´åˆã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
                const startHour = activity.startTime.getHours();
                const startMinute = activity.startTime.getMinutes();
                const endHour = activity.endTime.getHours();
                const endMinute = activity.endTime.getMinutes();
                const startPosition = (startHour * 60 + startMinute) / (24 * 60) * 100;
                const endPosition = (endHour * 60 + endMinute) / (24 * 60) * 100;
                const width = endPosition - startPosition;

                if (width < 5) {
                    narrowIndex++;
                }
            });
        }

        // DiCEææ¡ˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ä½œæˆ
        function createDiCETimelineAxis(container, suggestions) {
            // DiCEææ¡ˆãƒãƒ¼ã‚’é…ç½®ï¼ˆãƒ¡ãƒ¢ãƒªãªã—ï¼‰
            let narrowIndex = 0;
            suggestions.forEach(suggestion => {
                const suggestionBar = createDiCESuggestionBar(suggestion, narrowIndex);
                container.appendChild(suggestionBar);

                // narrow-activityã®å ´åˆã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
                const time = suggestion.timestamp || suggestion.original_timestamp;
                const timeObj = new Date(time);
                const hour = timeObj.getHours();
                const minute = timeObj.getMinutes();
                const startPosition = (hour * 60 + minute) / (24 * 60) * 100;

                let width;
                if (suggestion.time_range) {
                    const [startStr, endStr] = suggestion.time_range.split('-');
                    if (startStr && endStr) {
                        const [startHour, startMin] = startStr.split(':').map(Number);
                        const [endHour, endMin] = endStr.split(':').map(Number);
                        const durationMinutes = (endHour * 60 + endMin) - (startHour * 60 + startMin);
                        width = durationMinutes / (24 * 60) * 100;
                    } else {
                        width = 60 / (24 * 60) * 100;
                    }
                } else {
                    width = 60 / (24 * 60) * 100;
                }

                if (width < 5) {
                    narrowIndex++;
                }
            });
        }

        // æ´»å‹•ãƒãƒ¼ã‚’ä½œæˆ
        function createActivityBar(activity, narrowIndex) {
            const startHour = activity.startTime.getHours();
            const startMinute = activity.startTime.getMinutes();
            const endHour = activity.endTime.getHours();
            const endMinute = activity.endTime.getMinutes();

            // ä½ç½®ã‚’è¨ˆç®—ï¼ˆ0%ã€œ100%ï¼‰
            const startPosition = (startHour * 60 + startMinute) / (24 * 60) * 100;
            const endPosition = (endHour * 60 + endMinute) / (24 * 60) * 100;
            const width = endPosition - startPosition;

            const activityBar = document.createElement('div');
            activityBar.className = 'timeline-activity-bar';

            // ãƒ•ãƒ©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å€¤ã§è‰²åˆ†ã‘ï¼ˆ1-20ã‚¹ã‚±ãƒ¼ãƒ«ï¼‰
            const avgFrustration = activity.avgFrustration;
            if (avgFrustration == null) {
                // ãƒ‡ãƒ¼ã‚¿ãªã—ã®å ´åˆã¯ã‚°ãƒ¬ãƒ¼
                activityBar.classList.add('no-data');
            } else if (avgFrustration <= 6) {
                activityBar.classList.add('low-stress');    // 1-6: ä½ã‚¹ãƒˆãƒ¬ã‚¹
            } else if (avgFrustration <= 13) {
                activityBar.classList.add('medium-stress'); // 7-13: ä¸­ã‚¹ãƒˆãƒ¬ã‚¹
            } else {
                activityBar.classList.add('high-stress');   // 14-20: é«˜ã‚¹ãƒˆãƒ¬ã‚¹
            }

            // ä½ç½®ã¨ã‚µã‚¤ã‚ºã‚’è¨­å®š
            activityBar.style.left = startPosition + '%';
            activityBar.style.width = Math.max(width, 2) + '%'; // æœ€å°2%ã®å¹…

            // çŸ­ã„æ´»å‹•ï¼ˆ5%ä»¥ä¸‹ï¼šç´„72åˆ†ä»¥ä¸‹ï¼‰ã®å ´åˆã€æ´»å‹•åã‚’ä¸Šã«è¡¨ç¤º
            if (width < 5) {
                activityBar.classList.add('narrow-activity');
                // å¶æ•°ç•ªç›®ï¼ˆ1,3,5...ï¼‰ã¯2æ®µç›®ã«è¡¨ç¤º
                if (narrowIndex % 2 === 1) {
                    activityBar.classList.add('label-row-2');
                }
            }

            // æ´»å‹•æƒ…å ±ã‚’è¡¨ç¤º
            const activityInfo = document.createElement('div');
            activityInfo.className = 'activity-bar-info';

            const startTimeStr = activity.startTime.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            const endTimeStr = activity.endTime.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

            // ãƒ•ãƒ©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å€¤ã®è¡¨ç¤º
            const frustrationDisplay = avgFrustration != null
                ? `F:${avgFrustration.toFixed(1)}`
                : 'F:--';

            activityInfo.innerHTML = `
                <div class="activity-bar-name">${activity.activity}</div>
                <div class="activity-bar-time">${startTimeStr}-${endTimeStr}</div>
                <div class="activity-bar-frustration">${frustrationDisplay}</div>
            `;

            activityBar.appendChild(activityInfo);

            // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—
            const frustrationTooltip = avgFrustration != null
                ? avgFrustration.toFixed(1)
                : 'äºˆæ¸¬ãªã—';
            activityBar.title = `${activity.activity}\n${startTimeStr} - ${endTimeStr}\nç¶™ç¶šæ™‚é–“: ${Math.round(activity.durationMinutes)}åˆ†\nãƒ•ãƒ©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: ${frustrationTooltip}`;

            return activityBar;
        }

        // DiCEææ¡ˆãƒãƒ¼ã‚’ä½œæˆ
        function createDiCESuggestionBar(suggestion, narrowIndex) {
            // æ™‚åˆ»ã‹ã‚‰æ™‚é–“ã®ä½ç½®ã‚’è¨ˆç®—
            const time = suggestion.timestamp || suggestion.original_timestamp;
            const timeObj = new Date(time);
            const hour = timeObj.getHours();
            const minute = timeObj.getMinutes();

            // é–‹å§‹ä½ç½®ã‚’è¨ˆç®—
            const startPosition = (hour * 60 + minute) / (24 * 60) * 100;

            // å¹…ã‚’è¨ˆç®—ï¼štime_rangeãŒã‚ã‚Œã°å®Ÿéš›ã®ç¶™ç¶šæ™‚é–“ã€ãªã‘ã‚Œã°1æ™‚é–“
            let width;
            let durationMinutes = 60; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ1æ™‚é–“
            let timeRangeStr = '';

            if (suggestion.time_range) {
                // time_rangeï¼ˆä¾‹: "13:00-16:00"ï¼‰ã‚’ãƒ‘ãƒ¼ã‚¹
                const [startStr, endStr] = suggestion.time_range.split('-');
                if (startStr && endStr) {
                    const [startHour, startMin] = startStr.split(':').map(Number);
                    const [endHour, endMin] = endStr.split(':').map(Number);

                    // ç¶™ç¶šæ™‚é–“ã‚’åˆ†å˜ä½ã§è¨ˆç®—
                    durationMinutes = (endHour * 60 + endMin) - (startHour * 60 + startMin);

                    // å¹…ã‚’ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã§è¨ˆç®—
                    width = durationMinutes / (24 * 60) * 100;
                    timeRangeStr = suggestion.time_range;
                } else {
                    // ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ãŸå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                    width = 60 / (24 * 60) * 100;
                    timeRangeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                }
            } else {
                // time_rangeãŒãªã„å ´åˆã¯1æ™‚é–“å¹…
                width = 60 / (24 * 60) * 100;
                timeRangeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
            }

            const suggestionBar = document.createElement('div');
            suggestionBar.className = 'dice-suggestion-bar';

            // ä½ç½®ã¨ã‚µã‚¤ã‚ºã‚’è¨­å®š
            suggestionBar.style.left = startPosition + '%';
            suggestionBar.style.width = Math.max(width, 3) + '%'; // æœ€å°3%ã®å¹…

            // çŸ­ã„æ´»å‹•ï¼ˆ5%ä»¥ä¸‹ï¼šç´„72åˆ†ä»¥ä¸‹ï¼‰ã®å ´åˆã€æ´»å‹•åã‚’ä¸Šã«è¡¨ç¤º
            if (width < 5) {
                suggestionBar.classList.add('narrow-activity');
                // å¶æ•°ç•ªç›®ï¼ˆ1,3,5...ï¼‰ã¯2æ®µç›®ã«è¡¨ç¤º
                if (narrowIndex % 2 === 1) {
                    suggestionBar.classList.add('label-row-2');
                }
            }

            // ææ¡ˆæƒ…å ±ã‚’è¡¨ç¤º
            const suggestionInfo = document.createElement('div');
            suggestionInfo.className = 'activity-bar-info';

            const timeStr = timeObj.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

            suggestionInfo.innerHTML = `
                <div class="activity-bar-name" style="font-size: 12px; margin-bottom: 2px;">${suggestion.suggested_activity || 'æ”¹å–„ææ¡ˆ'}</div>
                <div class="activity-bar-time" style="font-size: 9px; opacity: 0.8;">${timeRangeStr}</div>
                <div class="activity-bar-duration" style="font-size: 9px; opacity: 0.85; margin-top: 2px;">${(suggestion.frustration_reduction || 0).toFixed(1)}ç‚¹æ”¹å–„</div>
            `;

            suggestionBar.appendChild(suggestionInfo);

            // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—
            suggestionBar.title = `${timeRangeStr}ã®æ”¹å–„ææ¡ˆ\n${suggestion.original_activity} â†’ ${suggestion.suggested_activity}\nç¶™ç¶šæ™‚é–“: ${durationMinutes}åˆ†\næœŸå¾…åŠ¹æœ: ${(suggestion.frustration_reduction || 0).toFixed(1)}ç‚¹æ”¹å–„`;

            return suggestionBar;
        }

        // DiCEææ¡ˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤ºæ›´æ–°
        function updateDiCETimeline(analysis) {
            const container = document.getElementById('dice-timeline-container');
            container.innerHTML = '<div class="timeline-title">DiCEæ”¹å–„ææ¡ˆ</div>';

            if (!analysis || !analysis.timeline || analysis.timeline.length === 0) {
                const noSuggestions = document.createElement('div');
                noSuggestions.style.position = 'absolute';
                noSuggestions.style.top = '50%';
                noSuggestions.style.left = '50%';
                noSuggestions.style.transform = 'translate(-50%, -50%)';
                noSuggestions.style.opacity = '0.6';
                noSuggestions.textContent = 'æ”¹å–„ææ¡ˆãªã—';
                container.appendChild(noSuggestions);
                return;
            }

            // DiCEææ¡ˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ä½œæˆ
            createDiCETimelineAxis(container, analysis.timeline);
        }


        // DiCEè¡¨ç¤ºæ›´æ–°ï¼ˆè¡¨å½¢å¼ãƒ»ä¸Šä½3ä»¶ã®ã¿ï¼‰
        function updateDiCEDisplay(analysis) {
            document.getElementById('total-improvement').textContent =
                (analysis.total_improvement || 0).toFixed(1);

            const container = document.getElementById('suggestions-container');
            container.innerHTML = '';

            if (analysis.timeline && analysis.timeline.length > 0) {
                // æ”¹å–„ç‚¹ãŒå¤§ãã„é †ã«ã‚½ãƒ¼ãƒˆ
                const sortedSuggestions = [...analysis.timeline].sort((a, b) =>
                    (b.frustration_reduction || 0) - (a.frustration_reduction || 0)
                );

                // ä¸Šä½3ä»¶ã®ã¿å–å¾—
                const topSuggestions = sortedSuggestions.slice(0, 3);
                const totalCount = analysis.timeline.length;

                // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
                const table = document.createElement('table');
                table.className = 'suggestions-table';

                // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>æ™‚åˆ»</th>
                            <th>æ´»å‹•</th>
                            <th>æ”¹å–„ç‚¹</th>
                        </tr>
                    </thead>
                    <tbody id="suggestions-tbody"></tbody>
                `;

                container.appendChild(table);

                // ãƒ†ãƒ¼ãƒ–ãƒ«æœ¬ä½“ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                const tbody = document.getElementById('suggestions-tbody');
                topSuggestions.forEach(item => {
                    const time = new Date(item.timestamp).toLocaleTimeString('ja-JP', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="table-time">${time}</td>
                        <td class="table-activity">
                            <span class="table-current">${item.original_activity}</span><span class="table-arrow">â†’</span><span class="table-suggested">${item.suggested_activity}</span>
                        </td>
                        <td class="table-improvement">+${item.frustration_reduction.toFixed(1)}</td>
                    `;
                    tbody.appendChild(row);
                });

                // ä¸Šä½Nä»¶è¡¨ç¤ºã®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ï¼ˆ4ä»¶ä»¥ä¸Šã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤ºï¼‰
                if (totalCount > 3) {
                    const indicator = document.createElement('div');
                    indicator.className = 'top-n-indicator';
                    indicator.textContent = `â€» å…¨${totalCount}ä»¶ä¸­ã€æ”¹å–„åŠ¹æœã®é«˜ã„ä¸Šä½3ä»¶ã‚’è¡¨ç¤º`;
                    container.appendChild(indicator);
                }

            } else {
                const noSuggestionsMessage = document.createElement('div');
                noSuggestionsMessage.className = 'no-suggestions-message';
                noSuggestionsMessage.textContent = 'ç¾åœ¨ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯è‰¯å¥½ã§ã™ã€‚æ”¹å–„ææ¡ˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
                container.appendChild(noSuggestionsMessage);
            }

            // DiCEã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤ºã‚‚æ›´æ–°
            updateDiCETimeline(analysis);
        }

        // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤ºæ›´æ–°
        function updateFeedbackDisplay(feedback, feedbackType) {
            // å®Ÿé¨“æ¡ä»¶ã«å¿œã˜ã¦DiCEç‰ˆã‹æ¨å®šå€¤ã®ã¿ç‰ˆã‹ã‚’åˆ¤å®š
            const showDice = shouldShowDiCE(currentUser);

            // é©åˆ‡ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠ
            let feedbackText;
            if (showDice) {
                feedbackText = feedback.main_feedback || 'ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æº–å‚™ä¸­ã§ã™...';
            } else {
                feedbackText = feedback.main_feedback_no_dice || 'ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æº–å‚™ä¸­ã§ã™...';
            }

            // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            feedbackText = feedbackText.replace(
                /(æ”¹å–„|å‘ä¸Š|åŠ¹æœçš„|ãŠã™ã™ã‚|é‡è¦|æ³¨æ„)/g,
                '<span class="feedback-highlight">$1</span>'
            );

            // å˜ä¸€ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¦ç´ ã‚’æ›´æ–°
            const feedbackElement = document.getElementById('feedback-text');
            if (feedbackElement) {
                feedbackElement.innerHTML = feedbackText;
            }

            console.log(`ğŸ“ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤ºæ›´æ–°: ${showDice ? 'DiCEç‰ˆ' : 'æ¨å®šå€¤ã®ã¿ç‰ˆ'}`);
        }

        // æ¬¡å›DiCEæ™‚åˆ»æ›´æ–°
        function updateNextDiCETime() {
            const nextTime = new Date(lastDiceUpdate + diceUpdateInterval);
            const timeString = nextTime.toLocaleTimeString('ja-JP', {
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('next-dice').textContent = timeString;
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºåˆ¶å¾¡
        function showLoading(show) {
            const indicator = document.getElementById('loading-indicator');
            if (show) {
                indicator.classList.add('active');
            } else {
                indicator.classList.remove('active');
            }
        }

        // æœ€çµ‚æ›´æ–°æ™‚åˆ»æ›´æ–°
        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ja-JP', {
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('last-update').textContent = `æœ€çµ‚æ›´æ–°: ${timeString}`;
        }

        // ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹è¡¨ç¤º
        function showErrorState() {
            document.getElementById('daily-frustration-value').textContent = 'ERR';
            document.getElementById('daily-info').textContent = 'ãƒ‡ãƒ¼ã‚¿æ¥ç¶šã‚¨ãƒ©ãƒ¼';
            document.getElementById('feedback-text').textContent = 'ã‚·ã‚¹ãƒ†ãƒ ã«ä¸€æ™‚çš„ãªå•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚';
        }

        console.log('ğŸ“± ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨äºˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†');
        console.log('æ©Ÿèƒ½: æ‰‹å‹•ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠ, ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ äºˆæ¸¬å€¤è¡¨ç¤º, 1æ™‚é–“ã”ã¨+æ´»å‹•å ±å‘Šæ™‚DiCEå®Ÿè¡Œ');
        console.log('ğŸ”® äºˆæ¸¬ã‚¨ãƒ³ã‚¸ãƒ³: /api/frustration/predict-activity ã‚’ä½¿ç”¨');
        console.log('âœ¨ å…¨ã¦ã®è¡¨ç¤ºå€¤ã¯MLãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚‹äºˆæ¸¬å€¤ã§ã™');

        // ã€ä¸€æ™‚çš„ã€‘ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«æ©Ÿèƒ½

        // ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
        function closeDebugPanel() {
            const panel = document.getElementById('debug-panel');
            panel.style.display = 'none';
            console.log('ğŸ› ï¸ ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã¾ã—ãŸï¼ˆå¾Œã§å‰Šé™¤ã—ã¦ãã ã•ã„ï¼‰');
        }

        // æ‰‹å‹•DiCEåˆ†æãƒˆãƒªã‚¬ãƒ¼
        async function triggerManualDiCE() {
            const button = document.getElementById('manual-dice-button');
            const statusElement = document.getElementById('debug-status');

            try {
                // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                button.disabled = true;
                statusElement.textContent = 'ğŸ”„ DiCEåˆ†æå®Ÿè¡Œä¸­...';
                statusElement.style.background = 'rgba(255, 152, 0, 0.5)';

                console.log('ğŸ² æ‰‹å‹•DiCEåˆ†æã‚’é–‹å§‹...');

                // APIå‘¼ã³å‡ºã—
                const response = await fetch('/api/debug/dice-scheduler/trigger', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUser
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    console.log('âœ… æ‰‹å‹•DiCEåˆ†æå®Œäº†:', data);
                    statusElement.textContent = 'âœ… DiCEåˆ†æå®Œäº†ï¼';
                    statusElement.style.background = 'rgba(76, 175, 80, 0.5)';

                    // çµæœã‚’è¡¨ç¤ºã«åæ˜ 
                    if (data.data && data.data.full_result) {
                        updateDiCEDisplay(data.data.full_result);

                        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æƒ…å ±ã‚’è¡¨ç¤º
                        const improvement = data.data.total_improvement || 0;
                        const scheduleItems = data.data.schedule_items || 0;

                        setTimeout(() => {
                            statusElement.textContent = `æ”¹å–„: ${improvement.toFixed(1)}ç‚¹ (${scheduleItems}ä»¶ã®ææ¡ˆ)`;
                        }, 2000);
                    }

                    // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                    setTimeout(() => {
                        loadUserData(currentUser);
                    }, 1000);

                } else {
                    console.error('âŒ æ‰‹å‹•DiCEåˆ†æå¤±æ•—:', data);
                    statusElement.textContent = 'âŒ åˆ†æã‚¨ãƒ©ãƒ¼';
                    statusElement.style.background = 'rgba(244, 67, 54, 0.5)';
                }

            } catch (error) {
                console.error('âŒ æ‰‹å‹•DiCEåˆ†æã‚¨ãƒ©ãƒ¼:', error);
                statusElement.textContent = 'âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼';
                statusElement.style.background = 'rgba(244, 67, 54, 0.5)';
            } finally {
                // 3ç§’å¾Œã«ãƒœã‚¿ãƒ³ã‚’å†åº¦æœ‰åŠ¹åŒ–
                setTimeout(() => {
                    button.disabled = false;
                    if (statusElement.textContent.includes('å®Ÿè¡Œä¸­')) {
                        statusElement.textContent = 'å¾…æ©Ÿä¸­';
                        statusElement.style.background = 'rgba(0, 0, 0, 0.3)';
                    }
                }, 3000);
            }
        }

        console.log('ğŸ› ï¸ ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰: æ‰‹å‹•DiCEãƒœã‚¿ãƒ³ãŒæœ‰åŠ¹ã§ã™ï¼ˆå¾Œã§å‰Šé™¤ã—ã¦ãã ã•ã„ï¼‰');
    </script>
</body>
</html>