<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Çø„Éñ„É¨„ÉÉ„ÉàÁî®„Éï„É©„Çπ„Éà„É¨„Éº„Ç∑„Éß„É≥ÂàÜÊûê„Ç∑„Çπ„ÉÜ„É†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* „Éò„ÉÉ„ÉÄ„Éº - „É¶„Éº„Ç∂„ÉºÈÅ∏Êäû */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 1000;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            font-size: 20px;
            font-weight: bold;
        }

        .user-selector {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .current-user-display {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 15px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .current-user-display:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.05);
        }

        .user-icon-small {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            background: rgba(76, 175, 80, 0.3);
            border: 2px solid #4CAF50;
        }

        /* „É¶„Éº„Ç∂„ÉºÈÅ∏Êäû„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥ */
        .user-dropdown {
            position: absolute;
            top: 70px;
            right: 30px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 15px;
            min-width: 200px;
            display: none;
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 10000;
        }

        .user-dropdown.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s ease;
            margin: 5px 0;
        }

        .user-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .user-option.selected {
            background: rgba(76, 175, 80, 0.3);
        }

        /* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ - „Çø„Éñ„É¨„ÉÉ„ÉàÊúÄÈÅ©ÂåñÔºö‰∏äÊÆµ3„Ç´„É©„É†+‰∏ãÊÆµ„Çø„Ç§„É†„É©„Ç§„É≥ */
        .main-container {
            margin-top: 70px;
            height: calc(100vh - 70px);
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 15px;
            overflow: hidden;
            max-width: 100vw;
        }

        /* ‰∏äÊÆµÔºö‰∫àÊ∏¨ÂÄ§„ÉªÊîπÂñÑÊèêÊ°à„Éª„Ç¢„Éâ„Éê„Ç§„Çπ„ÅÆÊ®™‰∏¶„Å≥ */
        .top-row {
            display: flex;
            gap: 15px;
            height: 28%;
            min-height: 200px;
            max-height: 220px;
        }

        /* ‰∏ãÊÆµÔºö„Çø„Ç§„É†„É©„Ç§„É≥ÂÖ®ÂπÖ */
        .bottom-row {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        /* ‰ªäÊó•„ÅÆ„Éï„É©„Çπ„Éà„É¨„Éº„Ç∑„Éß„É≥ÂÄ§ - ‰ªñ„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„Å®Áµ±‰∏Ä */
        .daily-analysis {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            flex: 1;
            position: relative;
            overflow-y: auto;
            min-height: 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .daily-analysis::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 70%);
            animation: pulse 8s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: rotate(0deg) scale(1); opacity: 0.3; }
            50% { transform: rotate(180deg) scale(1.1); opacity: 0.6; }
        }

        .section-title {
            font-size: 14px;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            gap: 6px;
            position: relative;
            z-index: 2;
            font-weight: 600;
        }

        .section-icon {
            font-size: 18px;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.3));
        }

        /* ‰ªäÊó•„ÅÆ„Éï„É©„Çπ„Éà„É¨„Éº„Ç∑„Éß„É≥ÂÄ§Ë°®Á§∫ - „Åï„Çâ„Å´„Ç≥„É≥„Éë„ÇØ„ÉàÂåñ */
        .daily-frustration {
            text-align: center;
            margin: 0;
            position: relative;
            z-index: 2;
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .frustration-value {
            font-size: 2.8em;
            font-weight: bold;
            margin: 0;
            text-shadow: 0 0 25px rgba(255, 255, 255, 0.6);
            transition: all 1s ease;
            display: block;
            line-height: 1.1;
        }

        .frustration-low { color: #4CAF50; }
        .frustration-medium { color: #FF9800; }
        .frustration-high { color: #F44336; }

        .daily-stats {
            display: flex;
            justify-content: space-around;
            gap: 6px;
            margin-top: 3px;
            position: relative;
            z-index: 2;
        }

        .stat-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.15);
            padding: 4px 6px;
            border-radius: 6px;
            flex: 1;
        }

        .stat-value {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 1px;
        }

        .stat-label {
            font-size: 9px;
            opacity: 0.9;
        }

        /* 24ÊôÇÈñì„Çø„Ç§„É†„É©„Ç§„É≥ - ÂÖ®ÂπÖ1Ë°åË°®Á§∫ */
        .timeline-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .timeline-container {
            position: relative;
            margin-top: 8px;
            padding: 18px 10px 8px 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            height: 110px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .dice-timeline-container {
            position: relative;
            margin-top: 8px;
            padding: 18px 10px 8px 10px;
            background: rgba(0, 100, 0, 0.1);
            border: 2px solid rgba(76, 175, 80, 0.3);
            border-radius: 10px;
            height: 110px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .timeline-title {
            position: absolute;
            top: 2px;
            left: 10px;
            font-size: 12px;
            font-weight: bold;
            opacity: 0.8;
        }

        .timeline-activity {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 8px;
            margin: 4px;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
            flex-shrink: 0;
        }

        .timeline-activity:hover {
            transform: scale(1.02);
            z-index: 10;
            background: rgba(255, 255, 255, 0.3) !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .timeline-activity.low-stress { 
            background: rgba(76, 175, 80, 0.7); 
            border-color: #4CAF50;
        }
        .timeline-activity.medium-stress { 
            background: rgba(255, 152, 0, 0.7); 
            border-color: #FF9800;
        }
        .timeline-activity.high-stress { 
            background: rgba(244, 67, 54, 0.7); 
            border-color: #F44336;
        }

        .activity-info {
            text-align: center;
            font-size: 10px;
        }

        .activity-name {
            font-weight: bold;
            font-size: 11px;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .activity-time {
            font-size: 8px;
            opacity: 0.9;
            margin-bottom: 1px;
        }

        .activity-duration {
            font-size: 8px;
            opacity: 0.8;
        }

        .activity-frustration {
            font-size: 9px;
            font-weight: bold;
            margin-top: 2px;
        }

        /* ÊôÇÈñìËª∏„Éô„Éº„Çπ„Çø„Ç§„É†„É©„Ç§„É≥ */
        .timeline-axis {
            position: absolute;
            top: 0;
            left: 10px;
            right: 10px;
            height: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
        }

        .hour-marker {
            position: absolute;
            height: 20px;
            width: 1px;
            background: rgba(255, 255, 255, 0.2);
            top: 0;
        }

        .hour-marker.major { /* 0, 3, 6, 9, 12, 15, 18, 21ÊôÇ */
            background: rgba(255, 255, 255, 0.6);
            width: 3px;
        }

        .hour-label {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: rgba(255, 255, 255, 0.7);
            white-space: nowrap;
        }

        .hour-marker.major .hour-label {
            color: rgba(255, 255, 255, 0.95);
            font-weight: bold;
            font-size: 11px;
        }

        .timeline-activity-bar {
            position: absolute;
            top: 18px;
            height: 85px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            overflow: hidden;
        }

        .timeline-activity-bar:hover {
            transform: translateY(-2px);
            z-index: 10;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        .timeline-activity-bar.low-stress {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.85), rgba(139, 195, 74, 0.85));
            border-color: #4CAF50;
        }

        .timeline-activity-bar.medium-stress {
            background: linear-gradient(135deg, rgba(255, 152, 0, 0.85), rgba(255, 193, 7, 0.85));
            border-color: #FF9800;
        }

        .timeline-activity-bar.high-stress {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.85), rgba(233, 30, 99, 0.85));
            border-color: #F44336;
        }

        .timeline-activity-bar.no-data {
            background: linear-gradient(135deg, rgba(150, 150, 150, 0.6), rgba(120, 120, 120, 0.6));
            border-color: #999;
            border-style: dashed;
        }

        .dice-suggestion-bar {
            position: absolute;
            top: 18px;
            height: 85px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px dashed rgba(76, 175, 80, 0.6);
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(139, 195, 74, 0.3));
            overflow: hidden;
        }

        .dice-suggestion-bar:hover {
            transform: translateY(-2px);
            z-index: 10;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            border-color: #4CAF50;
        }

        .activity-bar-info {
            padding: 8px 6px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: center;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
            gap: 3px;
        }

        .activity-bar-name {
            font-weight: bold;
            font-size: 13px;
            margin-bottom: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }

        .activity-bar-time {
            font-size: 10px;
            opacity: 0.9;
            margin-bottom: 0;
            line-height: 1.1;
        }

        .activity-bar-frustration {
            font-size: 10px;
            font-weight: bold;
            margin-top: 0;
            line-height: 1.1;
        }

        .timeline-legend {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 10px;
            opacity: 0.7;
        }

        /* DiCEÊîπÂñÑÊèêÊ°à - „Ç≥„É≥„Éë„ÇØ„ÉàÂåñ */
        .dice-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            flex: 1;
            position: relative;
            overflow-y: auto;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .dice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .dice-status {
            font-size: 12px;
            padding: 5px 10px;
            background: rgba(76, 175, 80, 0.3);
            border-radius: 15px;
            border: 1px solid #4CAF50;
        }

        .total-improvement {
            text-align: center;
            margin: 15px 0;
            font-size: 16px;
        }

        .improvement-value {
            font-size: 2.2em;
            font-weight: bold;
            color: #4CAF50;
            margin: 0 8px;
        }

        /* DiCEÊèêÊ°à„ÉÜ„Éº„Éñ„É´ - „Çø„Éñ„É¨„ÉÉ„ÉàÊúÄÈÅ©ÂåñÔºà„Çπ„ÇØ„É≠„Éº„É´„Å™„ÅóÔºâ */
        .suggestions-container {
            flex: 1;
            overflow: visible;
            padding-right: 5px;
            min-height: 0;
        }

        .suggestions-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            margin-top: 5px;
        }

        .suggestions-table thead {
            background: rgba(76, 175, 80, 0.2);
            border-bottom: 2px solid rgba(76, 175, 80, 0.4);
        }

        .suggestions-table th {
            padding: 5px 6px;
            text-align: left;
            font-weight: bold;
            color: #4CAF50;
            font-size: 11px;
            border-bottom: 2px solid rgba(76, 175, 80, 0.3);
        }

        .suggestions-table th:last-child {
            text-align: center;
            width: 70px;
        }

        .suggestions-table td {
            padding: 6px 6px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            vertical-align: middle;
        }

        .suggestions-table tr:last-child td {
            border-bottom: none;
        }

        .suggestions-table tbody tr {
            transition: background 0.2s ease;
        }

        .suggestions-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .table-time {
            font-weight: bold;
            color: #4CAF50;
            font-size: 12px;
            white-space: nowrap;
            width: 55px;
        }

        .table-activity {
            font-size: 10px;
            line-height: 1.3;
            white-space: nowrap;
        }

        .table-current {
            color: #FF9800;
        }

        .table-arrow {
            color: rgba(255, 255, 255, 0.5);
            margin: 0 3px;
        }

        .table-suggested {
            color: #4CAF50;
            font-weight: bold;
        }

        .table-improvement {
            text-align: center;
            font-weight: bold;
            color: #4CAF50;
            font-size: 16px;
            white-space: nowrap;
        }

        .no-suggestions-message {
            text-align: center;
            padding: 20px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
        }

        .top-n-indicator {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 3px;
            text-align: center;
        }

        /* „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„Çª„ÇØ„Ç∑„Éß„É≥ - „Ç≥„É≥„Éë„ÇØ„ÉàÂåñ */
        .feedback-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            flex: 1;
            position: relative;
            overflow-y: auto;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .feedback-text {
            font-size: 12px;
            line-height: 1.5;
            margin-top: 8px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            position: relative;
            z-index: 2;
            flex: 1;
            overflow-y: auto;
        }

        .feedback-highlight {
            color: #FFD700;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.3);
        }

        /* „Ç∑„Çπ„ÉÜ„É†ÊÉÖÂ†± */
        .system-info {
            position: fixed;
            bottom: 15px;
            left: 20px;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #4CAF50;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        /* „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫ */
        .loading-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 30px;
            height: 30px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .loading-indicator.active {
            opacity: 1;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* „Çø„Éñ„É¨„ÉÉ„ÉàÁâπÂåñ„É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú */
        @media (max-width: 1200px) and (min-width: 769px) {
            /* „Çø„Éñ„É¨„ÉÉ„ÉàÁî®Ë™øÊï¥ */
            .main-container {
                gap: 15px;
                padding: 15px;
            }
            
            .section-title {
                font-size: 20px;
            }
            
            .timeline-container,
            .dice-timeline-container {
                height: 90px;
            }
        }
        
        @media (max-width: 768px) {
            /* „Çπ„Éû„Éº„Éà„Éï„Ç©„É≥Áî® */
            .main-container {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }
            
            .visualization-panel,
            .feedback-panel {
                flex: none;
                max-width: none;
                height: auto;
            }
            
            .daily-stats {
                grid-template-columns: 1fr;
                gap: 5px;
            }
            
            .section-title {
                font-size: 16px;
            }
            
            .frustration-value {
                font-size: 2.8em;
            }
            
            .timeline-container,
            .dice-timeline-container {
                height: 70px;
            }
        }
        
        /* Â§ßÂûã„Çø„Éñ„É¨„ÉÉ„Éà/„Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÁî® */
        @media (min-width: 1201px) {
            .main-container {
                max-width: 1400px;
                margin: 70px auto 0;
                padding: 25px;
                gap: 25px;
            }

            /* Êû†„ÅÆ„Çµ„Ç§„Ç∫„ÅØÂ∞è„Åï„ÅÑÁîªÈù¢„Å®Âêå„Åò„Å´‰øù„Å§ */
            /* .daily-analysis { min-height: 320px; } „ÇíÂâäÈô§ */

            .frustration-value {
                font-size: 3.5em;
            }
        }

        /* „Çø„ÉÉ„ÉÅ„Éá„Éê„Ç§„ÇπÊúÄÈÅ©Âåñ */
        @media (pointer: coarse) {
            .user-option, .suggestion-item {
                min-height: 48px; /* „Çø„ÉÉ„ÉÅ„Åó„ÇÑ„Åô„ÅÑ„Çµ„Ç§„Ç∫ */
                cursor: pointer;
            }

            .current-user-display {
                min-height: 48px;
                padding: 12px 20px;
            }

            .timeline-activity-bar,
            .dice-suggestion-bar {
                min-width: 30px; /* „Çø„ÉÉ„ÉÅ„Åó„ÇÑ„Åô„ÅÑÊúÄÂ∞èÂπÖ */
            }

            /* „Çø„ÉÉ„ÉÅÊôÇ„ÅÆ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÂº∑Âåñ */
            .suggestion-item:active {
                transform: scale(0.98);
                background: rgba(255, 255, 255, 0.25);
            }
        }

        /* „Äê‰∏ÄÊôÇÁöÑ„Äë„Éá„Éê„ÉÉ„Ç∞„Éú„Çø„É≥„Çπ„Çø„Ç§„É´ */
        .debug-panel {
            position: fixed;
            bottom: 60px;
            right: 20px;
            background: rgba(244, 67, 54, 0.9);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 12px;
            border: 2px solid rgba(244, 67, 54, 0.5);
            z-index: 1000;
            display: none; /* „Éá„Éê„ÉÉ„Ç∞„Éë„Éç„É´„ÇíÈùûË°®Á§∫ */
            flex-direction: column;
            gap: 10px;
            min-width: 200px;
        }

        .debug-label {
            font-size: 11px;
            font-weight: bold;
            color: #FFD700;
            text-align: center;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .debug-button {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .debug-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }

        .debug-button:active {
            transform: scale(0.95);
        }

        .debug-button:disabled {
            background: linear-gradient(135deg, #999, #888);
            cursor: not-allowed;
            transform: none;
        }

        .debug-status {
            font-size: 10px;
            text-align: center;
            color: white;
            padding: 5px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            min-height: 20px;
        }

        .debug-close {
            position: absolute;
            top: 5px;
            right: 8px;
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            opacity: 0.7;
            padding: 0;
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
        }

        .debug-close:hover {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
    <div class="header">
        <div class="logo">üß† „Éï„É©„Çπ„Éà„É¨„Éº„Ç∑„Éß„É≥ÂàÜÊûê</div>
        <div class="user-selector">
            <div class="current-user-display" onclick="toggleUserDropdown()">
                <div class="user-icon-small" id="current-user-icon">üë§</div>
                <span id="current-user-name">„Éá„Éï„Ç©„É´„Éà</span>
                <span style="margin-left: 5px;">‚ñº</span>
            </div>
        </div>
    </div>

    <!-- „É¶„Éº„Ç∂„ÉºÈÅ∏Êäû„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥ -->
    <div class="user-dropdown" id="user-dropdown">
        <div class="user-option selected" data-user-id="default" onclick="selectUser('default', 'üë§', '„Éá„Éï„Ç©„É´„Éà')">
            <div class="user-icon-small">üë§</div>
            <span>„Éá„Éï„Ç©„É´„Éà</span>
        </div>
        <div class="user-option" data-user-id="user1" onclick="selectUser('user1', 'üë®', 'Â∞èÊâãÂ∑ù')">
            <div class="user-icon-small">üë®</div>
            <span>Â∞èÊâãÂ∑ù</span>
        </div>
        <div class="user-option" data-user-id="user2" onclick="selectUser('user2', 'üë©', 'Ê¶éÊú¨')">
            <div class="user-icon-small">üë©</div>
            <span>Ê¶éÊú¨</span>
        </div>
        <div class="user-option" data-user-id="user3" onclick="selectUser('user3', 'üßë', 'Èï∑Â±±')">
            <div class="user-icon-small">üßë</div>
            <span>Èï∑Â±±</span>
        </div>
        <div class="user-option" data-user-id="user4" onclick="selectUser('user4', 'üë¶', 'Êü¥Áî∞')">
            <div class="user-icon-small">üë¶</div>
            <span>Êü¥Áî∞</span>
        </div>
        <div class="user-option" data-user-id="user5" onclick="selectUser('user5', 'üëß', 'Á´πÁî∞')">
            <div class="user-icon-small">üëß</div>
            <span>Á´πÁî∞</span>
        </div>
        <div class="user-option" data-user-id="user6" onclick="selectUser('user6', 'üßí', 'Êñ∞Âêç')">
            <div class="user-icon-small">üßí</div>
            <span>Êñ∞Âêç</span>
        </div>
        <div class="user-option" data-user-id="user7" onclick="selectUser('user7', 'üë®‚Äçü¶±', 'ÂØ∫Â≤°')">
            <div class="user-icon-small">üë®‚Äçü¶±</div>
            <span>ÂØ∫Â≤°</span>
        </div>
        <div class="user-option" data-user-id="user8" onclick="selectUser('user8', 'üë©‚Äçü¶±', 'ÂâçÂú∞')">
            <div class="user-icon-small">üë©‚Äçü¶±</div>
            <span>ÂâçÂú∞</span>
        </div>
        <div class="user-option" data-user-id="user9" onclick="selectUser('user9', 'üßë‚Äçü¶±', '„É¶„Éº„Ç∂„Éº9')">
            <div class="user-icon-small">üßë‚Äçü¶±</div>
            <span>„É¶„Éº„Ç∂„Éº9</span>
        </div>
    </div>

    <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞„Ç§„É≥„Ç∏„Ç±„Éº„Çø -->
    <div class="loading-indicator" id="loading-indicator"></div>

    <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
    <div class="main-container">
        <!-- ‰∏äÊÆµÔºö‰∫àÊ∏¨ÂÄ§„ÉªÊîπÂñÑÊèêÊ°à„Éª„Ç¢„Éâ„Éê„Ç§„Çπ -->
        <div class="top-row">
            <!-- ‰ªäÊó•„ÅÆ„Éï„É©„Çπ„Éà„É¨„Éº„Ç∑„Éß„É≥ÂÄ§ -->
            <div class="daily-analysis">
                <h2 class="section-title">
                    <span class="section-icon">üîÆ</span>
                    ‰∫àÊ∏¨ÂÄ§
                </h2>

                <div class="daily-frustration">
                    <div class="frustration-value frustration-medium" id="daily-frustration-value">--</div>
                    <div style="font-size: 12px; opacity: 0.8;" id="daily-info">Ë®àÁÆó‰∏≠...</div>
                </div>

                <div class="daily-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="daily-min">--</div>
                        <div class="stat-label">ÊúÄÂ∞è</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="daily-max">--</div>
                        <div class="stat-label">ÊúÄÂ§ß</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="daily-activities">--</div>
                        <div class="stat-label">Ê¥ªÂãï</div>
                    </div>
                </div>
            </div>

            <!-- DiCEÊîπÂñÑÊèêÊ°à -->
            <div class="dice-section">
                <div class="dice-header">
                    <h2 class="section-title">
                        <span class="section-icon">üéØ</span>
                        ÊîπÂñÑÊèêÊ°à
                        <span style="margin-left: 10px; font-size: 14px; font-weight: normal; color: #4CAF50;">
                            ÂêàË®à: <span id="total-improvement" style="font-size: 1.3em; font-weight: bold;">--</span>ÁÇπ
                        </span>
                    </h2>
                    <div class="dice-status" id="dice-status">ÂàÜÊûê‰∏≠...</div>
                </div>

                <div class="suggestions-container" id="suggestions-container">
                    <table class="suggestions-table">
                        <thead>
                            <tr>
                                <th>ÊôÇÂàª</th>
                                <th>Ê¥ªÂãï</th>
                                <th>ÊîπÂñÑÁÇπ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="3" style="text-align: center; padding: 15px; color: rgba(255,255,255,0.6);">
                                    ÂàÜÊûê‰∏≠...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- „Ç¢„Éâ„Éê„Ç§„Çπ -->
            <div class="feedback-section">
                <h2 class="section-title">
                    <span class="section-icon">üí¨</span>
                    <span id="feedback-type">‰ªäÊó•„ÅÆ</span>„Ç¢„Éâ„Éê„Ç§„Çπ
                </h2>
                <div class="feedback-text" id="feedback-text">
                    „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÇíÁîüÊàê‰∏≠„Åß„Åô...
                </div>
            </div>
        </div>

        <!-- ‰∏ãÊÆµÔºö„Çø„Ç§„É†„É©„Ç§„É≥ÂÖ®ÂπÖ -->
        <div class="bottom-row">
            <div class="timeline-section">
                <h2 class="section-title">
                    <span class="section-icon">‚è∞</span>
                    ‰ªäÊó•„ÅÆÊ¥ªÂãï„Çø„Ç§„É†„É©„Ç§„É≥
                </h2>
                <div class="timeline-container" id="timeline-container">
                    <div class="timeline-title">ÂÆüÈöõ„ÅÆÊ¥ªÂãï</div>
                    <!-- 24ÊôÇÈñìÂàÜ„ÅÆË¶ÅÁ¥†„ÅåÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„Çã -->
                </div>
                <div class="timeline-legend" style="font-size: 9px;">
                    <span>0</span>
                    <span>3</span>
                    <span>6</span>
                    <span>9</span>
                    <span>12</span>
                    <span>15</span>
                    <span>18</span>
                    <span>21</span>
                    <span>24</span>
                </div>

                <div class="dice-timeline-container" id="dice-timeline-container">
                    <div class="timeline-title">DiCEÊîπÂñÑÊèêÊ°à</div>
                    <!-- DiCEÊèêÊ°à„ÅåÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„Çã -->
                </div>
                <div class="timeline-legend" style="font-size: 9px;">
                    <span>0</span>
                    <span>3</span>
                    <span>6</span>
                    <span>9</span>
                    <span>12</span>
                    <span>15</span>
                    <span>18</span>
                    <span>21</span>
                    <span>24</span>
                </div>
            </div>
        </div>
    </div>

    <!-- „Ç∑„Çπ„ÉÜ„É†ÊÉÖÂ†± -->
    <div class="system-info">
        <div class="status-dot"></div>
        <span id="update-status">Ëá™ÂãïÊõ¥Êñ∞‰∏≠</span>
        <span>|</span>
        <span id="last-update">ÊúÄÁµÇÊõ¥Êñ∞: --:--</span>
        <span>|</span>
        <span>Ê¨°ÂõûDiCE: <span id="next-dice">--:--</span></span>
    </div>

    <!-- „Äê‰∏ÄÊôÇÁöÑ„Äë„Éá„Éê„ÉÉ„Ç∞„Éë„Éç„É´ -->
    <div class="debug-panel" id="debug-panel">
        <button class="debug-close" onclick="closeDebugPanel()" title="„Éá„Éê„ÉÉ„Ç∞„Éë„Éç„É´„ÇíÈñâ„Åò„Çã">√ó</button>
        <div class="debug-label">üõ†Ô∏è DEBUG MODE</div>
        <button class="debug-button" id="manual-dice-button" onclick="triggerManualDiCE()">
            üé≤ DiCEÂàÜÊûê„ÇíÂÆüË°å
        </button>
        <div class="debug-status" id="debug-status">ÂæÖÊ©ü‰∏≠</div>
    </div>

    <script>
        // „ÄêÊ§úË®ºÁî®„ÄëË°®Á§∫ÊôÇÈñì„ÅÆË®≠ÂÆöÔºà„Åì„Åì„ÇíÂ§âÊõ¥„Åó„Å¶Ê§úË®ºÂèØËÉΩÔºâ
        const DISPLAY_TIMES = [
            { start: 22, end: 25, startMinute: 50 },  // 22:50-25:00ÔºàÁøå1:00Ôºâ- Ê§úË®ºÁî®
            { start: 6, end: 9, startMinute: 0 }      // 6:00-9:00
        ];

        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let currentUser = localStorage.getItem('selectedUser') || 'default'; // localStorage„Åã„ÇâÂæ©ÂÖÉ
        let dataUpdateInterval = 300000; // 5ÂàÜ„Åî„Å®„Å´„Éá„Éº„ÇøÊõ¥Êñ∞
        let diceUpdateInterval = 3600000; // 1ÊôÇÈñì„Åî„Å®„Å´DiCEÂàÜÊûê
        let lastDiceUpdate = 0;
        let lastActivityCount = 0;

        // ÁîªÈù¢„Çπ„É™„Éº„ÉóÈò≤Ê≠¢Áî®„ÅÆWake Lock API
        let wakeLock = null;

        // ÁèæÂú®ÊôÇÂàª„ÅåË°®Á§∫ÊôÇÈñìÂÜÖ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        function isDisplayTime() {
            const now = new Date();
            const hour = now.getHours();
            const minute = now.getMinutes();

            for (const timeRange of DISPLAY_TIMES) {
                const startHour = timeRange.start;
                const startMinute = timeRange.startMinute || 0;
                const endHour = timeRange.end;

                // 25ÊôÇÔºàÁøå1ÊôÇÔºâ„Å™„Å©„ÅÆÂá¶ÁêÜ
                if (endHour > 24) {
                    // Êó•„Çí„Åæ„Åü„ÅêÂ†¥Âêà
                    if (hour >= startHour || hour < (endHour - 24)) {
                        // ÈñãÂßãÊôÇÂàª„ÅÆÂàÜ„ÉÅ„Çß„ÉÉ„ÇØ
                        if (hour === startHour && minute < startMinute) {
                            continue;
                        }
                        return true;
                    }
                } else {
                    // ÈÄöÂ∏∏„ÅÆÊôÇÈñìÁØÑÂõ≤
                    if (hour >= startHour && hour < endHour) {
                        // ÈñãÂßãÊôÇÂàª„ÅÆÂàÜ„ÉÅ„Çß„ÉÉ„ÇØ
                        if (hour === startHour && minute < startMinute) {
                            continue;
                        }
                        return true;
                    }
                }
            }
            return false;
        }

        // ÂæÖÊ©üÁîªÈù¢„ÇíË°®Á§∫
        function showWaitingScreen() {
            const body = document.body;
            body.style.background = '#000';
            body.innerHTML = `
                <div style="display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; color: #666; font-size: 24px;">
                    <div style="margin-bottom: 20px;">‚è∞</div>
                    <div>Ë°®Á§∫ÊôÇÈñìÂ§ñ„Åß„Åô</div>
                    <div style="font-size: 16px; margin-top: 10px;">Ê¨°„ÅÆË°®Á§∫ÊôÇÈñì: 22:50-1:00, 6:00-9:00</div>
                </div>
            `;
            console.log('‚è∞ Ë°®Á§∫ÊôÇÈñìÂ§ñ„ÅÆ„Åü„ÇÅÂæÖÊ©ü‰∏≠...');
        }

        // Wake Lock„ÇíÂèñÂæó„Åó„Å¶„Çπ„É™„Éº„ÉóÈò≤Ê≠¢
        async function preventScreenSleep() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('üîã ÁîªÈù¢„Çπ„É™„Éº„ÉóÈò≤Ê≠¢: ÊúâÂäπ');

                    wakeLock.addEventListener('release', () => {
                        console.log('üîã ÁîªÈù¢„Çπ„É™„Éº„ÉóÈò≤Ê≠¢: Ëß£Èô§');
                    });
                } else {
                    console.warn('‚ö†Ô∏è Wake Lock API„ÅØ„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„Åß„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºöÂÆöÊúüÁöÑ„Å´ÁîªÈù¢„ÇíÊõ¥Êñ∞
                    setInterval(() => {
                        document.body.style.opacity = 0.9999;
                        setTimeout(() => { document.body.style.opacity = 1; }, 100);
                    }, 30000); // 30Áßí„Åî„Å®
                }
            } catch (err) {
                console.error('Wake LockÂèñÂæó„Ç®„É©„Éº:', err);
            }
        }

        // „Éö„Éº„Ç∏„ÅåÂÜç„Å≥Ë°®Á§∫„Åï„Çå„Åü„Å®„Åç„Å´Wake Lock„ÇíÂÜçÂèñÂæó
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                await preventScreenSleep();
            }
        });

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            // Ë°®Á§∫ÊôÇÈñì„ÉÅ„Çß„ÉÉ„ÇØ
            if (isDisplayTime()) {
                console.log('‚úÖ Ë°®Á§∫ÊôÇÈñìÂÜÖ - „Ç¢„Éó„É™„ÇíËµ∑Âãï„Åó„Åæ„Åô');
                initializeSystem();
                startAutoUpdate();
                startDiCEScheduler();
                preventScreenSleep(); // ÁîªÈù¢„Çπ„É™„Éº„ÉóÈò≤Ê≠¢„ÇíÈñãÂßã

                // „Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíÈñâ„Åò„Çã„Åü„ÇÅ„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
                document.addEventListener('click', function(event) {
                    if (!event.target.closest('.user-selector')) {
                        closeUserDropdown();
                    }
                });
            } else {
                console.log('‚è∞ Ë°®Á§∫ÊôÇÈñìÂ§ñ - ÂæÖÊ©üÁîªÈù¢„ÇíË°®Á§∫„Åó„Åæ„Åô');
                showWaitingScreen();

                // 1ÂàÜ„Åî„Å®„Å´ÊôÇÂàª„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                setInterval(() => {
                    if (isDisplayTime()) {
                        console.log('‚úÖ Ë°®Á§∫ÊôÇÈñì„Å´„Å™„Çä„Åæ„Åó„Åü - „É™„É≠„Éº„Éâ„Åó„Åæ„Åô');
                        location.reload();
                    }
                }, 60000); // 60Áßí„Åî„Å®
            }
        });

        // „Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ
        function initializeSystem() {
            console.log('üéÆ „Çø„Éñ„É¨„ÉÉ„ÉàÁî®„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ‰∏≠...');

            // localStorage„Åã„ÇâÂæ©ÂÖÉ„Åó„Åü„É¶„Éº„Ç∂„Éº„ÅßUI„ÇíÊõ¥Êñ∞
            restoreUserUI();

            loadUserData(currentUser);
        }

        // ‰øùÂ≠ò„Åï„Çå„Åü„É¶„Éº„Ç∂„Éº„ÅßUI„ÇíÂæ©ÂÖÉ
        function restoreUserUI() {
            // „É¶„Éº„Ç∂„Éº„Éû„ÉÉ„Éî„É≥„Ç∞
            const userMap = {
                'default': { icon: 'üë§', name: '„Éá„Éï„Ç©„É´„Éà' },
                'user1': { icon: 'üë®', name: 'Â∞èÊâãÂ∑ù' },
                'user2': { icon: 'üë©', name: 'Ê¶éÊú¨' },
                'user3': { icon: 'üßë', name: 'Èï∑Â±±' },
                'user4': { icon: 'üë¶', name: 'Êü¥Áî∞' },
                'user5': { icon: 'üëß', name: 'Á´πÁî∞' },
                'user6': { icon: 'üßí', name: 'Êñ∞Âêç' },
                'user7': { icon: 'üë®‚Äçü¶±', name: 'ÂØ∫Â≤°' },
                'user8': { icon: 'üë©‚Äçü¶±', name: 'ÂâçÂú∞' },
                'user9': { icon: 'üßë‚Äçü¶±', name: '„É¶„Éº„Ç∂„Éº9' }
            };

            const userInfo = userMap[currentUser] || userMap['default'];

            // „Éò„ÉÉ„ÉÄ„Éº„ÅÆUI„ÇíÊõ¥Êñ∞
            document.getElementById('current-user-icon').textContent = userInfo.icon;
            document.getElementById('current-user-name').textContent = userInfo.name;

            // „Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            document.querySelectorAll('.user-option').forEach(option => {
                option.classList.remove('selected');
            });
            const selectedOption = document.querySelector(`[data-user-id="${currentUser}"]`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }

            console.log(`üîÑ „É¶„Éº„Ç∂„ÉºUIÂæ©ÂÖÉ: ${currentUser} (${userInfo.name})`);
        }

        // „É¶„Éº„Ç∂„Éº„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥Ë°®Á§∫Âàá„ÇäÊõø„Åà
        function toggleUserDropdown() {
            const dropdown = document.getElementById('user-dropdown');
            dropdown.classList.toggle('active');
        }

        // „É¶„Éº„Ç∂„Éº„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíÈñâ„Åò„Çã
        function closeUserDropdown() {
            const dropdown = document.getElementById('user-dropdown');
            dropdown.classList.remove('active');
        }

        // „É¶„Éº„Ç∂„ÉºÈÅ∏Êäû
        function selectUser(userId, icon, name) {
            if (userId === currentUser) {
                closeUserDropdown();
                return;
            }
            
            console.log(`üë§ „É¶„Éº„Ç∂„ÉºÂ§âÊõ¥: ${currentUser} ‚Üí ${userId}`);
            
            // UIÊõ¥Êñ∞
            document.getElementById('current-user-icon').textContent = icon;
            document.getElementById('current-user-name').textContent = name;
            
            // ÈÅ∏ÊäûÁä∂ÊÖãÊõ¥Êñ∞
            document.querySelectorAll('.user-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector(`[data-user-id="${userId}"]`).classList.add('selected');

            currentUser = userId;
            localStorage.setItem('selectedUser', userId); // localStorage„Å´‰øùÂ≠ò
            console.log(`üíæ „É¶„Éº„Ç∂„ÉºÈÅ∏Êäû„Çí‰øùÂ≠ò: ${userId}`);
            closeUserDropdown();

            // „Éá„Éº„ÇøË™≠„ÅøËæº„Åø
            loadUserData(userId);
        }

        // Ëá™Âãï„Éá„Éº„ÇøÊõ¥Êñ∞ÈñãÂßã
        function startAutoUpdate() {
            // Âç≥Â∫ß„Å´‰∏ÄÂ∫¶ÂÆüË°å
            loadUserData(currentUser);
            
            // ÂÆöÊúüÊõ¥Êñ∞
            setInterval(() => {
                loadUserData(currentUser);
            }, dataUpdateInterval);
        }

        // DiCE„Çπ„Ç±„Ç∏„É•„Éº„É©„ÉºÈñãÂßã
        function startDiCEScheduler() {
            // 1ÊôÇÈñì„Åî„Å®„ÅÆDiCEÂÆüË°å
            setInterval(() => {
                executeDiCEAnalysis(currentUser);
            }, diceUpdateInterval);
            
            // ÂàùÂõûDiCEÂÆüË°åÔºà10ÁßíÂæåÔºâ
            setTimeout(() => {
                executeDiCEAnalysis(currentUser);
            }, 10000);
        }

        // „É¶„Éº„Ç∂„Éº„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
        async function loadUserData(userId) {
            console.log(`üìä „Éá„Éº„ÇøÊõ¥Êñ∞ÈñãÂßã: ${userId}`);
            showLoading(true);
            
            try {
                // ‰∏¶Ë°å„Åó„Å¶„Éá„Éº„Çø„ÇíÂèñÂæó
                await Promise.all([
                    loadDailyFrustration(userId),
                    loadTimeline(userId),
                    loadFeedback(userId)
                ]);
                
                // Ê¥ªÂãïÊï∞„ÅåÂ¢ó„Åà„ÅüÂ†¥Âêà„ÅØDiCEÂàÜÊûê„ÇíÂÆüË°å
                await checkForNewActivities(userId);
                
                updateLastUpdateTime();
                updateNextDiCETime();
                
            } catch (error) {
                console.error('„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                showErrorState();
            } finally {
                showLoading(false);
            }
        }

        // ‰ªäÊó•„ÅÆ„Éï„É©„Çπ„Éà„É¨„Éº„Ç∑„Éß„É≥ÂÄ§Ë™≠„ÅøËæº„ÅøÔºà‰∫àÊ∏¨ÂÄ§„Éô„Éº„ÇπÔºâ
        async function loadDailyFrustration(userId) {
            try {
                // „Åæ„ÅöÊ¥ªÂãï„Éá„Éº„Çø„ÇíÂèñÂæó
                const response = await fetch('/api/frustration/timeline', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        user_id: userId,
                        date: new Date().toISOString().split('T')[0]
                    })
                });

                const data = await response.json();
                
                if (data.status === 'success' && data.timeline.length > 0) {
                    // ÂêÑÊ¥ªÂãï„Å´ÂØæ„Åó„Å¶„É™„Ç¢„É´„Çø„Ç§„É†‰∫àÊ∏¨„ÇíÂÆüË°å
                    await updateDailyFrustrationWithPredictions(data.timeline, userId);
                }
            } catch (error) {
                console.error('Êó•Ê¨°„Éï„É©„Çπ„Éà„É¨„Éº„Ç∑„Éß„É≥ÂÄ§ÂèñÂæó„Ç®„É©„Éº:', error);
            }
        }

        // ‰∫àÊ∏¨ÂÄ§„Éô„Éº„Çπ„ÅßÊó•Ê¨°„Éï„É©„Çπ„Éà„É¨„Éº„Ç∑„Éß„É≥Ë°®Á§∫„ÇíÊõ¥Êñ∞
        async function updateDailyFrustrationWithPredictions(timeline, userId) {
            const predictedTimeline = [];
            
            // ÂêÑÊ¥ªÂãï„Å´ÂØæ„Åó„Å¶‰∫àÊ∏¨„ÇíÂÆüË°å
            for (const item of timeline) {
                try {
                    const response = await fetch('/api/frustration/predict-activity', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_id: userId,
                            activity_category: item.activity,
                            duration: item.duration || 60,
                            timestamp: item.timestamp
                        })
                    });
                    
                    const predictionData = await response.json();
                    
                    if (predictionData.status === 'success') {
                        predictedTimeline.push({
                            ...item,
                            frustration_value: predictionData.predicted_frustration,
                            is_predicted: true,
                            confidence: predictionData.confidence || 0
                        });
                    } else {
                        // ‰∫àÊ∏¨„Å´Â§±Êïó„Åó„ÅüÂ†¥Âêà„ÅØnull„ÅÆ„Åæ„ÅæÔºàË°®Á§∫„Åó„Å™„ÅÑÔºâ
                        predictedTimeline.push({
                            ...item,
                            frustration_value: item.frustration_value || null,
                            is_predicted: false,
                            confidence: 0
                        });
                    }
                } catch (error) {
                    console.error('Ê¥ªÂãï‰∫àÊ∏¨„Ç®„É©„Éº:', error);
                    // „Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÅØnull„ÅÆ„Åæ„ÅæÔºàË°®Á§∫„Åó„Å™„ÅÑÔºâ
                    predictedTimeline.push({
                        ...item,
                        frustration_value: item.frustration_value || null,
                        is_predicted: false,
                        confidence: 0
                    });
                }
            }
            
            updateDailyFrustrationDisplay(predictedTimeline);
        }

        // „Çø„Ç§„É†„É©„Ç§„É≥Ë™≠„ÅøËæº„ÅøÔºà‰∫àÊ∏¨ÂÄ§„Éô„Éº„ÇπÊ¥ªÂãïË°®Á§∫Ôºâ
        async function loadTimeline(userId) {
            try {
                const response = await fetch('/api/frustration/timeline', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        user_id: userId,
                        date: new Date().toISOString().split('T')[0]
                    })
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    // ‰∫àÊ∏¨ÂÄ§„Åß„Çø„Ç§„É†„É©„Ç§„É≥Ë°®Á§∫„ÇíÊõ¥Êñ∞
                    await updateTimelineWithPredictions(data.timeline, userId);
                    
                    // Ê¥ªÂãïÊï∞„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    const currentActivityCount = data.timeline.length;
                    if (currentActivityCount > lastActivityCount) {
                        lastActivityCount = currentActivityCount;
                        console.log(`üéØ Êñ∞„Åó„ÅÑÊ¥ªÂãï„ÅåÊ§úÂá∫„Åï„Çå„Åæ„Åó„Åü: ${currentActivityCount - lastActivityCount}‰ª∂`);
                        
                        // Êñ∞„Åó„ÅÑÊ¥ªÂãï„ÅåÂ†±Âëä„Åï„Çå„ÅüÂ†¥Âêà„ÄÅDiCEÂàÜÊûê„ÇíÂÆüË°å
                        setTimeout(() => {
                            executeDiCEAnalysis(userId);
                        }, 5000); // 5ÁßíÂæå„Å´ÂÆüË°å
                    }
                }
            } catch (error) {
                console.error('„Çø„Ç§„É†„É©„Ç§„É≥Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
            }
        }

        // ‰∫àÊ∏¨ÂÄ§„Åß„Çø„Ç§„É†„É©„Ç§„É≥Ë°®Á§∫„ÇíÊõ¥Êñ∞
        async function updateTimelineWithPredictions(timeline, userId) {
            if (timeline.length === 0) {
                updateTimelineDisplay([]);
                return;
            }

            const predictedTimeline = [];
            
            // ÂêÑÊ¥ªÂãï„Å´ÂØæ„Åó„Å¶‰∫àÊ∏¨„ÇíÂÆüË°å
            for (const item of timeline) {
                try {
                    const response = await fetch('/api/frustration/predict-activity', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_id: userId,
                            activity_category: item.activity,
                            duration: item.duration || 60,
                            timestamp: item.timestamp
                        })
                    });
                    
                    const predictionData = await response.json();
                    
                    if (predictionData.status === 'success') {
                        predictedTimeline.push({
                            ...item,
                            frustration_value: predictionData.predicted_frustration,
                            is_predicted: true,
                            confidence: predictionData.confidence || 0
                        });
                    } else {
                        // ‰∫àÊ∏¨„Å´Â§±Êïó„Åó„ÅüÂ†¥Âêà„ÅØnull„ÅÆ„Åæ„ÅæÔºàË°®Á§∫„Åó„Å™„ÅÑÔºâ
                        predictedTimeline.push({
                            ...item,
                            frustration_value: item.frustration_value || null,
                            is_predicted: false,
                            confidence: 0
                        });
                    }
                } catch (error) {
                    console.error('Ê¥ªÂãï‰∫àÊ∏¨„Ç®„É©„Éº:', error);
                    // „Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÅØnull„ÅÆ„Åæ„ÅæÔºàË°®Á§∫„Åó„Å™„ÅÑÔºâ
                    predictedTimeline.push({
                        ...item,
                        frustration_value: item.frustration_value || null,
                        is_predicted: false,
                        confidence: 0
                    });
                }
            }
            
            updateTimelineDisplay(predictedTimeline);
        }

        // Êñ∞„Åó„ÅÑÊ¥ªÂãï„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        async function checkForNewActivities(userId) {
            // loadTimelineÂÜÖ„ÅßÂá¶ÁêÜ
        }

        // DiCEÂàÜÊûêÂÆüË°å
        async function executeDiCEAnalysis(userId) {
            console.log(`üé≤ DiCEÂàÜÊûêÂÆüË°å: ${userId}`);
            
            try {
                document.getElementById('dice-status').textContent = 'ÂàÜÊûê‰∏≠...';
                document.getElementById('dice-status').style.background = 'rgba(255, 152, 0, 0.3)';
                document.getElementById('dice-status').style.borderColor = '#FF9800';
                
                const response = await fetch('/api/frustration/dice-analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        user_id: userId,
                        lookback_hours: 24
                    })
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    updateDiCEDisplay(data.dice_analysis);
                    lastDiceUpdate = Date.now();
                    
                    document.getElementById('dice-status').textContent = 'ÂàÜÊûêÂÆå‰∫Ü';
                    document.getElementById('dice-status').style.background = 'rgba(76, 175, 80, 0.3)';
                    document.getElementById('dice-status').style.borderColor = '#4CAF50';
                }
            } catch (error) {
                console.error('DiCEÂàÜÊûê„Ç®„É©„Éº:', error);
                document.getElementById('dice-status').textContent = 'ÂàÜÊûê„Ç®„É©„Éº';
                document.getElementById('dice-status').style.background = 'rgba(244, 67, 54, 0.3)';
                document.getElementById('dice-status').style.borderColor = '#F44336';
            }
        }

        // „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØË™≠„ÅøËæº„Åø
        async function loadFeedback(userId) {
            try {
                const hour = new Date().getHours();
                const feedbackType = (hour >= 5 && hour < 12) ? 'morning' : 'evening';
                
                const response = await fetch('/api/feedback/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        user_id: userId,
                        type: feedbackType
                    })
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    updateFeedbackDisplay(data.feedback, feedbackType);
                }
            } catch (error) {
                console.error('„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÁîüÊàê„Ç®„É©„Éº:', error);
            }
        }

        // ‰ªäÊó•„ÅÆ„Éï„É©„Çπ„Éà„É¨„Éº„Ç∑„Éß„É≥Ë°®Á§∫Êõ¥Êñ∞
        function updateDailyFrustrationDisplay(timeline) {
            if (!timeline || timeline.length === 0) return;

            // ‰ªäÊó•„ÅÆÁµ±Ë®à„ÇíË®àÁÆóÔºàfrustration_value„Åånull„Åß„Å™„ÅÑ„ÇÇ„ÅÆ„Å†„ÅëÔºâ
            const frustrationValues = timeline
                .filter(item => item.frustration_value != null)
                .map(item => item.frustration_value);

            if (frustrationValues.length === 0) {
                // ‰∫àÊ∏¨ÂÄ§„Åå1„Å§„ÇÇ„Å™„ÅÑÂ†¥Âêà
                document.getElementById('daily-frustration-value').textContent = '--';
                document.getElementById('daily-info').textContent = '‰∫àÊ∏¨ÂÄ§„Å™„Åó';
                document.getElementById('daily-min').textContent = '--';
                document.getElementById('daily-max').textContent = '--';
                document.getElementById('daily-activities').textContent = 0;
                return;
            }

            const average = frustrationValues.reduce((sum, val) => sum + val, 0) / frustrationValues.length;
            const min = Math.min(...frustrationValues);
            const max = Math.max(...frustrationValues);

            // Ë°®Á§∫Êõ¥Êñ∞Ôºà1-20„Çπ„Ç±„Éº„É´ÂØæÂøúÔºâ
            const valueElement = document.getElementById('daily-frustration-value');
            valueElement.textContent = Math.round(average);
            valueElement.className = 'frustration-value ' +
                (average <= 6 ? 'frustration-low' :
                 average <= 13 ? 'frustration-medium' : 'frustration-high');

            document.getElementById('daily-info').textContent =
                `‰ªäÊó•„ÅÆ‰∫àÊ∏¨Âπ≥ÂùáÂÄ§ (${frustrationValues.length}Âõû„ÅÆÊ¥ªÂãï)`;

            document.getElementById('daily-min').textContent = Math.round(min);
            document.getElementById('daily-max').textContent = Math.round(max);
            document.getElementById('daily-activities').textContent = frustrationValues.length;
        }

        // „Çø„Ç§„É†„É©„Ç§„É≥Ë°®Á§∫Êõ¥Êñ∞ÔºàÊôÇÈñìËª∏„Éô„Éº„ÇπÔºâ
        function updateTimelineDisplay(timeline) {
            const container = document.getElementById('timeline-container');
            container.innerHTML = '';

            if (timeline.length === 0) return;

            // Ê¥ªÂãï„Éá„Éº„Çø„ÇíÂá¶ÁêÜ„Åó„Å¶ÊôÇÈñìËª∏„Å´ÈÖçÁΩÆ
            const processedActivities = processActivitiesForTimeline(timeline);
            
            // ÊôÇÈñìËª∏„Çí‰ΩúÊàêÔºà0:00-23:59„ÅÆ24ÊôÇÈñìÔºâ
            createTimelineAxis(container, processedActivities);
        }

        // Ê¥ªÂãï„Éá„Éº„Çø„ÇíÊôÇÈñìËª∏Áî®„Å´Âá¶ÁêÜ
        function processActivitiesForTimeline(timeline) {
            const processed = [];

            timeline.forEach(item => {
                const startTime = new Date(item.timestamp);
                const durationMinutes = item.duration || 0;
                const endTime = new Date(startTime.getTime() + durationMinutes * 60000);

                // Êó•„Çí„Åæ„Åü„ÅêÊ¥ªÂãï„ÅÆÂá¶ÁêÜÔºö„Åù„ÅÆÊó•„ÅÆ00:00‰ª•Èôç„ÅÆ„ÅøË°®Á§∫
                const todayStart = new Date(endTime);
                todayStart.setHours(0, 0, 0, 0);  // „Åù„ÅÆÊó•„ÅÆ00:00

                let displayStartTime = startTime;
                let displayDuration = durationMinutes;

                // ÈñãÂßãÊôÇÂàª„ÅåÂâçÊó•Ôºà00:00„Çà„ÇäÂâçÔºâ„ÅÆÂ†¥Âêà„ÄÅ00:00„Å´Âàá„ÇäË©∞„ÇÅ„Çã
                if (startTime < todayStart) {
                    displayStartTime = new Date(todayStart);
                    // Á∂ôÁ∂öÊôÇÈñì„ÇíË™øÊï¥Ôºà00:00„Åã„ÇâÁµÇ‰∫ÜÊôÇÂàª„Åæ„Åß„ÅÆÊôÇÈñìÔºâ
                    displayDuration = Math.floor((endTime - todayStart) / 60000);
                }

                processed.push({
                    activity: item.activity,
                    startTime: displayStartTime,  // Ë°®Á§∫Áî®„ÅÆÈñãÂßãÊôÇÂàª
                    endTime: endTime,
                    durationMinutes: displayDuration,  // Ë°®Á§∫Áî®„ÅÆÁ∂ôÁ∂öÊôÇÈñì
                    frustration: item.frustration_value,  // null„ÅÆÂ†¥Âêà„ÇÇ„Åù„ÅÆ„Åæ„Åæ‰øùÊåÅ
                    startHour: displayStartTime.getHours(),
                    startMinute: displayStartTime.getMinutes(),
                    endHour: endTime.getHours(),
                    endMinute: endTime.getMinutes(),
                    originalStartTime: startTime  // ÂÖÉ„ÅÆÈñãÂßãÊôÇÂàª„ÅØ‰øùÊåÅ
                });
            });

            // ÈÄ£Á∂ö„Åó„ÅüÂêå„ÅòÊ¥ªÂãï„Çí„Éû„Éº„Ç∏
            return mergeConsecutiveTimelineActivities(processed);
        }

        // ÊôÇÈñìËª∏„Éô„Éº„Çπ„Åß„ÅÆÈÄ£Á∂öÊ¥ªÂãï„Éû„Éº„Ç∏
        function mergeConsecutiveTimelineActivities(activities) {
            if (activities.length === 0) return [];
            
            // ÈñãÂßãÊôÇÈñì„Åß„ÇΩ„Éº„Éà
            const sorted = activities.sort((a, b) => a.startTime - b.startTime);
            const merged = [];
            let currentGroup = null;

            sorted.forEach(activity => {
                if (!currentGroup || 
                    currentGroup.activity !== activity.activity ||
                    Math.abs(currentGroup.endTime - activity.startTime) > 60000) { // 1ÂàÜ‰ª•‰∏ä„ÅÆÂ∑Æ„Åå„ÅÇ„Çå„Å∞Âà•„Ç∞„É´„Éº„Éó
                    
                    if (currentGroup) {
                        merged.push(currentGroup);
                    }
                    
                    currentGroup = {
                        activity: activity.activity,
                        startTime: activity.startTime,
                        endTime: activity.endTime,
                        durationMinutes: activity.durationMinutes,
                        frustrationValues: [activity.frustration],
                        avgFrustration: activity.frustration
                    };
                } else {
                    // Âêå„ÅòÊ¥ªÂãï„ÅßÈÄ£Á∂ö„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„Éû„Éº„Ç∏
                    currentGroup.endTime = activity.endTime;
                    currentGroup.durationMinutes += activity.durationMinutes;
                    currentGroup.frustrationValues.push(activity.frustration);
                    currentGroup.avgFrustration = currentGroup.frustrationValues.reduce((sum, val) => sum + val, 0) / currentGroup.frustrationValues.length;
                }
            });

            if (currentGroup) {
                merged.push(currentGroup);
            }

            return merged;
        }

        // ÊôÇÈñìËª∏„Çí‰ΩúÊàê
        function createTimelineAxis(container, activities) {
            // Ê¥ªÂãï„Éê„Éº„ÇíÈÖçÁΩÆÔºà„É°„É¢„É™„Å™„ÅóÔºâ
            activities.forEach(activity => {
                const activityBar = createActivityBar(activity);
                container.appendChild(activityBar);
            });
        }

        // DiCEÊèêÊ°à„Çø„Ç§„É†„É©„Ç§„É≥‰ΩúÊàê
        function createDiCETimelineAxis(container, suggestions) {
            // DiCEÊèêÊ°à„Éê„Éº„ÇíÈÖçÁΩÆÔºà„É°„É¢„É™„Å™„ÅóÔºâ
            suggestions.forEach(suggestion => {
                const suggestionBar = createDiCESuggestionBar(suggestion);
                container.appendChild(suggestionBar);
            });
        }

        // Ê¥ªÂãï„Éê„Éº„Çí‰ΩúÊàê
        function createActivityBar(activity) {
            const startHour = activity.startTime.getHours();
            const startMinute = activity.startTime.getMinutes();
            const endHour = activity.endTime.getHours();
            const endMinute = activity.endTime.getMinutes();

            // ‰ΩçÁΩÆ„ÇíË®àÁÆóÔºà0%„Äú100%Ôºâ
            const startPosition = (startHour * 60 + startMinute) / (24 * 60) * 100;
            const endPosition = (endHour * 60 + endMinute) / (24 * 60) * 100;
            const width = endPosition - startPosition;

            const activityBar = document.createElement('div');
            activityBar.className = 'timeline-activity-bar';

            // „Éï„É©„Çπ„Éà„É¨„Éº„Ç∑„Éß„É≥ÂÄ§„ÅßËâ≤ÂàÜ„ÅëÔºà1-20„Çπ„Ç±„Éº„É´Ôºâ
            const avgFrustration = activity.avgFrustration;
            if (avgFrustration == null) {
                // „Éá„Éº„Çø„Å™„Åó„ÅÆÂ†¥Âêà„ÅØ„Ç∞„É¨„Éº
                activityBar.classList.add('no-data');
            } else if (avgFrustration <= 6) {
                activityBar.classList.add('low-stress');    // 1-6: ‰Ωé„Çπ„Éà„É¨„Çπ
            } else if (avgFrustration <= 13) {
                activityBar.classList.add('medium-stress'); // 7-13: ‰∏≠„Çπ„Éà„É¨„Çπ
            } else {
                activityBar.classList.add('high-stress');   // 14-20: È´ò„Çπ„Éà„É¨„Çπ
            }

            // ‰ΩçÁΩÆ„Å®„Çµ„Ç§„Ç∫„ÇíË®≠ÂÆö
            activityBar.style.left = startPosition + '%';
            activityBar.style.width = Math.max(width, 2) + '%'; // ÊúÄÂ∞è2%„ÅÆÂπÖ

            // Ê¥ªÂãïÊÉÖÂ†±„ÇíË°®Á§∫
            const activityInfo = document.createElement('div');
            activityInfo.className = 'activity-bar-info';

            const startTimeStr = activity.startTime.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            const endTimeStr = activity.endTime.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

            // „Éï„É©„Çπ„Éà„É¨„Éº„Ç∑„Éß„É≥ÂÄ§„ÅÆË°®Á§∫
            const frustrationDisplay = avgFrustration != null
                ? `F:${avgFrustration.toFixed(1)}`
                : 'F:--';

            activityInfo.innerHTML = `
                <div class="activity-bar-name">${activity.activity}</div>
                <div class="activity-bar-time">${startTimeStr}-${endTimeStr}</div>
                <div class="activity-bar-frustration">${frustrationDisplay}</div>
            `;

            activityBar.appendChild(activityInfo);

            // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó
            const frustrationTooltip = avgFrustration != null
                ? avgFrustration.toFixed(1)
                : '‰∫àÊ∏¨„Å™„Åó';
            activityBar.title = `${activity.activity}\n${startTimeStr} - ${endTimeStr}\nÁ∂ôÁ∂öÊôÇÈñì: ${Math.round(activity.durationMinutes)}ÂàÜ\n„Éï„É©„Çπ„Éà„É¨„Éº„Ç∑„Éß„É≥: ${frustrationTooltip}`;

            return activityBar;
        }

        // DiCEÊèêÊ°à„Éê„Éº„Çí‰ΩúÊàê
        function createDiCESuggestionBar(suggestion) {
            // ÊôÇÂàª„Åã„ÇâÊôÇÈñì„ÅÆ‰ΩçÁΩÆ„ÇíË®àÁÆó
            const time = suggestion.timestamp || suggestion.original_timestamp;
            const timeObj = new Date(time);
            const hour = timeObj.getHours();
            const minute = timeObj.getMinutes();

            // ÈñãÂßã‰ΩçÁΩÆ„ÇíË®àÁÆó
            const startPosition = (hour * 60 + minute) / (24 * 60) * 100;

            // ÂπÖ„ÇíË®àÁÆóÔºötime_range„Åå„ÅÇ„Çå„Å∞ÂÆüÈöõ„ÅÆÁ∂ôÁ∂öÊôÇÈñì„ÄÅ„Å™„Åë„Çå„Å∞1ÊôÇÈñì
            let width;
            let durationMinutes = 60; // „Éá„Éï„Ç©„É´„Éà1ÊôÇÈñì
            let timeRangeStr = '';

            if (suggestion.time_range) {
                // time_rangeÔºà‰æã: "13:00-16:00"Ôºâ„Çí„Éë„Éº„Çπ
                const [startStr, endStr] = suggestion.time_range.split('-');
                if (startStr && endStr) {
                    const [startHour, startMin] = startStr.split(':').map(Number);
                    const [endHour, endMin] = endStr.split(':').map(Number);

                    // Á∂ôÁ∂öÊôÇÈñì„ÇíÂàÜÂçò‰Ωç„ÅßË®àÁÆó
                    durationMinutes = (endHour * 60 + endMin) - (startHour * 60 + startMin);

                    // ÂπÖ„Çí„Éë„Éº„Çª„É≥„ÉÜ„Éº„Ç∏„ÅßË®àÁÆó
                    width = durationMinutes / (24 * 60) * 100;
                    timeRangeStr = suggestion.time_range;
                } else {
                    // „Éë„Éº„Çπ„Å´Â§±Êïó„Åó„ÅüÂ†¥Âêà„ÅØ„Éá„Éï„Ç©„É´„Éà
                    width = 60 / (24 * 60) * 100;
                    timeRangeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                }
            } else {
                // time_range„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ1ÊôÇÈñìÂπÖ
                width = 60 / (24 * 60) * 100;
                timeRangeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
            }

            const suggestionBar = document.createElement('div');
            suggestionBar.className = 'dice-suggestion-bar';

            // ‰ΩçÁΩÆ„Å®„Çµ„Ç§„Ç∫„ÇíË®≠ÂÆö
            suggestionBar.style.left = startPosition + '%';
            suggestionBar.style.width = Math.max(width, 3) + '%'; // ÊúÄÂ∞è3%„ÅÆÂπÖ

            // ÊèêÊ°àÊÉÖÂ†±„ÇíË°®Á§∫
            const suggestionInfo = document.createElement('div');
            suggestionInfo.className = 'activity-bar-info';

            const timeStr = timeObj.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

            suggestionInfo.innerHTML = `
                <div class="activity-bar-name" style="font-size: 12px; margin-bottom: 2px;">${suggestion.suggested_activity || 'ÊîπÂñÑÊèêÊ°à'}</div>
                <div class="activity-bar-time" style="font-size: 9px; opacity: 0.8;">${timeRangeStr}</div>
                <div class="activity-bar-duration" style="font-size: 9px; opacity: 0.85; margin-top: 2px;">${(suggestion.frustration_reduction || 0).toFixed(1)}ÁÇπÊîπÂñÑ</div>
            `;

            suggestionBar.appendChild(suggestionInfo);

            // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó
            suggestionBar.title = `${timeRangeStr}„ÅÆÊîπÂñÑÊèêÊ°à\n${suggestion.original_activity} ‚Üí ${suggestion.suggested_activity}\nÁ∂ôÁ∂öÊôÇÈñì: ${durationMinutes}ÂàÜ\nÊúüÂæÖÂäπÊûú: ${(suggestion.frustration_reduction || 0).toFixed(1)}ÁÇπÊîπÂñÑ`;

            return suggestionBar;
        }

        // DiCEÊèêÊ°à„Çø„Ç§„É†„É©„Ç§„É≥Ë°®Á§∫Êõ¥Êñ∞
        function updateDiCETimeline(analysis) {
            const container = document.getElementById('dice-timeline-container');
            container.innerHTML = '<div class="timeline-title">DiCEÊîπÂñÑÊèêÊ°à</div>';

            if (!analysis || !analysis.timeline || analysis.timeline.length === 0) {
                const noSuggestions = document.createElement('div');
                noSuggestions.style.position = 'absolute';
                noSuggestions.style.top = '50%';
                noSuggestions.style.left = '50%';
                noSuggestions.style.transform = 'translate(-50%, -50%)';
                noSuggestions.style.opacity = '0.6';
                noSuggestions.textContent = 'ÊîπÂñÑÊèêÊ°à„Å™„Åó';
                container.appendChild(noSuggestions);
                return;
            }

            // DiCEÊèêÊ°à„Çø„Ç§„É†„É©„Ç§„É≥‰ΩúÊàê
            createDiCETimelineAxis(container, analysis.timeline);
        }


        // DiCEË°®Á§∫Êõ¥Êñ∞ÔºàË°®ÂΩ¢Âºè„Éª‰∏ä‰Ωç3‰ª∂„ÅÆ„ÅøÔºâ
        function updateDiCEDisplay(analysis) {
            document.getElementById('total-improvement').textContent =
                (analysis.total_improvement || 0).toFixed(1);

            const container = document.getElementById('suggestions-container');
            container.innerHTML = '';

            if (analysis.timeline && analysis.timeline.length > 0) {
                // ÊîπÂñÑÁÇπ„ÅåÂ§ß„Åç„ÅÑÈ†Ü„Å´„ÇΩ„Éº„Éà
                const sortedSuggestions = [...analysis.timeline].sort((a, b) =>
                    (b.frustration_reduction || 0) - (a.frustration_reduction || 0)
                );

                // ‰∏ä‰Ωç3‰ª∂„ÅÆ„ÅøÂèñÂæó
                const topSuggestions = sortedSuggestions.slice(0, 3);
                const totalCount = analysis.timeline.length;

                // „ÉÜ„Éº„Éñ„É´„Çí‰ΩúÊàê
                const table = document.createElement('table');
                table.className = 'suggestions-table';

                // „ÉÜ„Éº„Éñ„É´„Éò„ÉÉ„ÉÄ„Éº
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>ÊôÇÂàª</th>
                            <th>Ê¥ªÂãï</th>
                            <th>ÊîπÂñÑÁÇπ</th>
                        </tr>
                    </thead>
                    <tbody id="suggestions-tbody"></tbody>
                `;

                container.appendChild(table);

                // „ÉÜ„Éº„Éñ„É´Êú¨‰Ωì„Å´„Éá„Éº„Çø„ÇíËøΩÂä†
                const tbody = document.getElementById('suggestions-tbody');
                topSuggestions.forEach(item => {
                    const time = new Date(item.timestamp).toLocaleTimeString('ja-JP', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="table-time">${time}</td>
                        <td class="table-activity">
                            <span class="table-current">${item.original_activity}</span><span class="table-arrow">‚Üí</span><span class="table-suggested">${item.suggested_activity}</span>
                        </td>
                        <td class="table-improvement">+${item.frustration_reduction.toFixed(1)}</td>
                    `;
                    tbody.appendChild(row);
                });

                // ‰∏ä‰ΩçN‰ª∂Ë°®Á§∫„ÅÆ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºÔºà4‰ª∂‰ª•‰∏ä„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„ÅøË°®Á§∫Ôºâ
                if (totalCount > 3) {
                    const indicator = document.createElement('div');
                    indicator.className = 'top-n-indicator';
                    indicator.textContent = `‚Äª ÂÖ®${totalCount}‰ª∂‰∏≠„ÄÅÊîπÂñÑÂäπÊûú„ÅÆÈ´ò„ÅÑ‰∏ä‰Ωç3‰ª∂„ÇíË°®Á§∫`;
                    container.appendChild(indicator);
                }

            } else {
                const noSuggestionsMessage = document.createElement('div');
                noSuggestionsMessage.className = 'no-suggestions-message';
                noSuggestionsMessage.textContent = 'ÁèæÂú®„ÅÆ„Éë„Çø„Éº„É≥„ÅØËâØÂ•Ω„Åß„Åô„ÄÇÊîπÂñÑÊèêÊ°à„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ';
                container.appendChild(noSuggestionsMessage);
            }

            // DiCE„Çø„Ç§„É†„É©„Ç§„É≥Ë°®Á§∫„ÇÇÊõ¥Êñ∞
            updateDiCETimeline(analysis);
        }

        // „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØË°®Á§∫Êõ¥Êñ∞
        function updateFeedbackDisplay(feedback, feedbackType) {
            document.getElementById('feedback-type').textContent = 
                feedbackType === 'morning' ? '‰ªäÊó•„ÅÆ' : '‰ªäÊó•„ÅÆÊåØ„ÇäËøî„Çä';
            
            let feedbackText = feedback.main_feedback || '„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÇíÊ∫ñÂÇô‰∏≠„Åß„Åô...';
            
            // „Ç≠„Éº„ÉØ„Éº„Éâ„Çí„Éè„Ç§„É©„Ç§„Éà
            feedbackText = feedbackText.replace(
                /(ÊîπÂñÑ|Âêë‰∏ä|ÂäπÊûúÁöÑ|„Åä„Åô„Åô„ÇÅ|ÈáçË¶Å|Ê≥®ÊÑè)/g, 
                '<span class="feedback-highlight">$1</span>'
            );

            document.getElementById('feedback-text').innerHTML = feedbackText;
        }

        // Ê¨°ÂõûDiCEÊôÇÂàªÊõ¥Êñ∞
        function updateNextDiCETime() {
            const nextTime = new Date(lastDiceUpdate + diceUpdateInterval);
            const timeString = nextTime.toLocaleTimeString('ja-JP', {
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('next-dice').textContent = timeString;
        }

        // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫Âà∂Âæ°
        function showLoading(show) {
            const indicator = document.getElementById('loading-indicator');
            if (show) {
                indicator.classList.add('active');
            } else {
                indicator.classList.remove('active');
            }
        }

        // ÊúÄÁµÇÊõ¥Êñ∞ÊôÇÂàªÊõ¥Êñ∞
        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ja-JP', {
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('last-update').textContent = `ÊúÄÁµÇÊõ¥Êñ∞: ${timeString}`;
        }

        // „Ç®„É©„ÉºÁä∂ÊÖãË°®Á§∫
        function showErrorState() {
            document.getElementById('daily-frustration-value').textContent = 'ERR';
            document.getElementById('daily-info').textContent = '„Éá„Éº„ÇøÊé•Á∂ö„Ç®„É©„Éº';
            document.getElementById('feedback-text').textContent = '„Ç∑„Çπ„ÉÜ„É†„Å´‰∏ÄÊôÇÁöÑ„Å™ÂïèÈ°å„ÅåÁô∫Áîü„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ';
        }

        console.log('üì± „Çø„Éñ„É¨„ÉÉ„ÉàÁî®‰∫àÊ∏¨„Ç∑„Çπ„ÉÜ„É†Ê∫ñÂÇôÂÆå‰∫Ü');
        console.log('Ê©üËÉΩ: ÊâãÂãï„É¶„Éº„Ç∂„ÉºÈÅ∏Êäû, „É™„Ç¢„É´„Çø„Ç§„É†‰∫àÊ∏¨ÂÄ§Ë°®Á§∫, 1ÊôÇÈñì„Åî„Å®+Ê¥ªÂãïÂ†±ÂëäÊôÇDiCEÂÆüË°å');
        console.log('üîÆ ‰∫àÊ∏¨„Ç®„É≥„Ç∏„É≥: /api/frustration/predict-activity „Çí‰ΩøÁî®');
        console.log('‚ú® ÂÖ®„Å¶„ÅÆË°®Á§∫ÂÄ§„ÅØML„É¢„Éá„É´„Å´„Çà„Çã‰∫àÊ∏¨ÂÄ§„Åß„Åô');

        // „Äê‰∏ÄÊôÇÁöÑ„Äë„Éá„Éê„ÉÉ„Ç∞„Éë„Éç„É´Ê©üËÉΩ

        // „Éá„Éê„ÉÉ„Ç∞„Éë„Éç„É´„ÇíÈñâ„Åò„Çã
        function closeDebugPanel() {
            const panel = document.getElementById('debug-panel');
            panel.style.display = 'none';
            console.log('üõ†Ô∏è „Éá„Éê„ÉÉ„Ç∞„Éë„Éç„É´„ÇíÈñâ„Åò„Åæ„Åó„ÅüÔºàÂæå„ÅßÂâäÈô§„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ');
        }

        // ÊâãÂãïDiCEÂàÜÊûê„Éà„É™„Ç¨„Éº
        async function triggerManualDiCE() {
            const button = document.getElementById('manual-dice-button');
            const statusElement = document.getElementById('debug-status');

            try {
                // „Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
                button.disabled = true;
                statusElement.textContent = 'üîÑ DiCEÂàÜÊûêÂÆüË°å‰∏≠...';
                statusElement.style.background = 'rgba(255, 152, 0, 0.5)';

                console.log('üé≤ ÊâãÂãïDiCEÂàÜÊûê„ÇíÈñãÂßã...');

                // APIÂëº„Å≥Âá∫„Åó
                const response = await fetch('/api/debug/dice-scheduler/trigger', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUser
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    console.log('‚úÖ ÊâãÂãïDiCEÂàÜÊûêÂÆå‰∫Ü:', data);
                    statusElement.textContent = '‚úÖ DiCEÂàÜÊûêÂÆå‰∫ÜÔºÅ';
                    statusElement.style.background = 'rgba(76, 175, 80, 0.5)';

                    // ÁµêÊûú„ÇíË°®Á§∫„Å´ÂèçÊò†
                    if (data.data && data.data.full_result) {
                        updateDiCEDisplay(data.data.full_result);

                        // „Çπ„ÉÜ„Éº„Çø„ÇπÊÉÖÂ†±„ÇíË°®Á§∫
                        const improvement = data.data.total_improvement || 0;
                        const scheduleItems = data.data.schedule_items || 0;

                        setTimeout(() => {
                            statusElement.textContent = `ÊîπÂñÑ: ${improvement.toFixed(1)}ÁÇπ (${scheduleItems}‰ª∂„ÅÆÊèêÊ°à)`;
                        }, 2000);
                    }

                    // „Éá„Éº„Çø„ÇíÂÜçË™≠„ÅøËæº„Åø
                    setTimeout(() => {
                        loadUserData(currentUser);
                    }, 1000);

                } else {
                    console.error('‚ùå ÊâãÂãïDiCEÂàÜÊûêÂ§±Êïó:', data);
                    statusElement.textContent = '‚ùå ÂàÜÊûê„Ç®„É©„Éº';
                    statusElement.style.background = 'rgba(244, 67, 54, 0.5)';
                }

            } catch (error) {
                console.error('‚ùå ÊâãÂãïDiCEÂàÜÊûê„Ç®„É©„Éº:', error);
                statusElement.textContent = '‚ùå ÈÄö‰ø°„Ç®„É©„Éº';
                statusElement.style.background = 'rgba(244, 67, 54, 0.5)';
            } finally {
                // 3ÁßíÂæå„Å´„Éú„Çø„É≥„ÇíÂÜçÂ∫¶ÊúâÂäπÂåñ
                setTimeout(() => {
                    button.disabled = false;
                    if (statusElement.textContent.includes('ÂÆüË°å‰∏≠')) {
                        statusElement.textContent = 'ÂæÖÊ©ü‰∏≠';
                        statusElement.style.background = 'rgba(0, 0, 0, 0.3)';
                    }
                }, 3000);
            }
        }

        console.log('üõ†Ô∏è „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ: ÊâãÂãïDiCE„Éú„Çø„É≥„ÅåÊúâÂäπ„Åß„ÅôÔºàÂæå„ÅßÂâäÈô§„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ');
    </script>
</body>
</html>